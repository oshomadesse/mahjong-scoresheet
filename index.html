<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»é›€ã‚¹ã‚³ã‚¢ã‚·ãƒ¼ãƒˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #2d5016 0%, #1a3d0a 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 15px;
        }

        h1 {
            text-align: center;
            color: #c41e3a;
            margin-bottom: 20px;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .section {
            background: #e8f5e9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #2d5016;
        }

        .section-title {
            color: #2d5016;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }

        .ranking-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .ranking-tab {
            background: white;
            border: 2px solid #2d5016;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #2d5016;
            font-size: 14px;
        }

        .ranking-tab:hover {
            background: #e8f5e9;
        }

        .ranking-tab.active {
            background: linear-gradient(135deg, #2d5016 0%, #1a3d0a 100%);
            color: white;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 2px solid #2d5016;
        }

        .ranking-item.first {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border: 3px solid #daa520;
        }

        .ranking-item.second {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            border: 3px solid #a8a8a8;
        }

        .ranking-item.third {
            background: linear-gradient(135deg, #cd7f32 0%, #e8a562 100%);
            border: 3px solid #b8732d;
        }

        .rank-number {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            min-width: 35px;
        }

        .player-name {
            font-size: 14px;
            font-weight: bold;
            color: #2d5016;
            flex: 1;
            margin-left: 10px;
            white-space: nowrap;
            padding-right: 10px;
            border-right: 3px solid rgba(45, 80, 22, 0.3);
        }

        .player-points {
            font-size: 18px;
            font-weight: bold;
            color: #c41e3a;
            margin-left: 10px;
            min-width: 50px;
            text-align: right;
        }

        .input-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }

        .input-item {
            display: flex;
            flex-direction: column;
        }

        .input-item label {
            font-weight: bold;
            color: #2d5016;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .input-item input {
            padding: 10px;
            border: 2px solid #2d5016;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: white;
        }

        .input-item input:focus {
            outline: none;
            border-color: #c41e3a;
        }

        .yakuman-check {
            display: flex;
            align-items: center;
            margin-top: 5px;
            gap: 8px;
            flex-wrap: wrap;
        }

        .yakuman-check > div {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .yakuman-check input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #c41e3a;
        }

        .yakuman-check label {
            margin: 0;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            color: #c41e3a;
        }

        .btn {
            background: linear-gradient(135deg, #c41e3a 0%, #9a1529 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(196, 30, 58, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .tabs-container {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .tab {
            background: white;
            border: 2px solid #2d5016;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #2d5016;
            font-size: 13px;
        }

        .tab:hover {
            background: #e8f5e9;
        }

        .tab.active {
            background: linear-gradient(135deg, #2d5016 0%, #1a3d0a 100%);
            color: white;
        }

        .add-section-btn {
            background: linear-gradient(135deg, #c41e3a 0%, #9a1529 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .add-section-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(196, 30, 58, 0.4);
        }

        .history-table-container {
            overflow-x: auto;
        }

        .history-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #2d5016;
            border-collapse: collapse;
        }

        .history-table th {
            background: linear-gradient(135deg, #2d5016 0%, #1a3d0a 100%);
            color: white;
            padding: 10px 5px;
            text-align: center;
            font-size: 11px;
            border: 1px solid #1a3d0a;
        }

        .history-table td {
            padding: 8px 5px;
            text-align: center;
            border: 1px solid #e0e0e0;
            font-size: 12px;
        }

        .history-table tr:nth-child(even) {
            background: #f5f5f5;
        }

        .history-table tr:hover {
            background: #e8f5e9;
        }

        .player-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .player-score {
            font-size: 11px;
            color: #666;
        }

        .player-point {
            font-weight: bold;
            font-size: 13px;
            color: #c41e3a;
        }
        
        .action-cell {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            gap: 6px !important;
            padding: 8px 4px !important;
            white-space: normal !important;
        }

        .yakuman-badge {
            background: #c39000;
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 3px;
            margin-top: 2px;
            display: inline-block;
            font-weight: bold;
        }

        .tobashi-badge {
            background: #c41e3a;
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 3px;
            margin-top: 2px;
            display: inline-block;
            font-weight: bold;
        }

        .tobi-badge {
            background: #2d5016;
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 3px;
            margin-top: 2px;
            display: inline-block;
            font-weight: bold;
        }

        /* ==== å¯¾å±€å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šã‚¹ãƒãƒ›æœ€é©åŒ–ï¼ˆiPhone13 mini å®Œå…¨å¯¾å¿œï¼‰ ==== */
        /* æ”¹è¡Œç¦æ­¢ï¼‹ä½™ç™½ã‚’è©°ã‚ã‚‹ */
        .history-table th,
        .history-table td {
            white-space: nowrap;
            padding: 4px !important;
        }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®åˆ—å¹…å›ºå®šåŒ– */
        .history-table {
            table-layout: fixed;
            width: 100%;
        }
        
        /* åŠè˜åˆ—ï¼ˆæ”¹è¡Œãªã—ï¼†å°ã•ãå›ºå®šï¼‰ */
        .history-table th:nth-child(1),
        .history-table td:nth-child(1) {
            width: 30px !important;
            min-width: 30px !important;
            max-width: 30px !important;
        }
        
        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3åˆ—ï¼ˆå‡ç­‰å¹…ã§æ”¹è¡Œãªã—ï¼‰ */
        .history-table th:nth-child(2),
        .history-table th:nth-child(3),
        .history-table th:nth-child(4),
        .history-table td:nth-child(2),
        .history-table td:nth-child(3),
        .history-table td:nth-child(4) {
            width: 60px !important;
            min-width: 60px !important;
            max-width: 60px !important;
        }
        
        /* æ“ä½œåˆ—ï¼ˆç´°ã„åˆ—å¹…ã§å›ºå®šï¼‰ */
        .history-table th:nth-child(5),
        .history-table td:nth-child(5) {
            width: auto !important;
            min-width: 40px !important;
            padding: 8px 4px !important;
        }
        
        /* æ“ä½œã‚»ãƒ«å†…ã®ãƒœã‚¿ãƒ³ï¼ˆç¸¦ä¸¦ã³ï¼‹ä½™ç™½ã‚ã‚Šï¼‹å°å‹åŒ–ï¼‰ */
        .action-cell button {
            display: block !important;   /* â† ã“ã‚ŒãŒç¸¦ç©ã¿ã®æ±ºå®šæ‰“ */
            width: 40px !important;
            height: 22px !important;
            padding: 0 !important;
            font-size: 10px !important;
            line-height: 22px !important;
            margin: 0 !important;
            border: 1px solid #2d5016;
            border-radius: 4px;
            background: white;
            color: #2d5016;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .action-cell button:hover {
            background: #e8f5e9;
            transform: scale(1.05);
        }

        .action-cell button:active {
            transform: scale(0.95);
        }

        .paypay-block {
            margin-top: 20px;
            padding: 18px;
            border-radius: 16px;
            background: #ff0033;
            color: #fff;
            text-align: center;
            display: none;
            gap: 12px;
            flex-direction: column;
            align-items: center;
        }

        .paypay-block__title {
            margin: 0 0 6px;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.08em;
        }

        .paypay-button {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 12px 16px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.18);
            color: #fff;
            text-decoration: none;
            font-weight: 700;
            letter-spacing: 0.04em;
            border: 2px solid rgba(255, 255, 255, 0.35);
            transition: background 0.2s ease;
        }

        .paypay-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .paypay-button--disabled {
            cursor: not-allowed;
            opacity: 0.7;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="passwordOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, #2d5016 0%, #1a3d0a 100%); z-index:10000; display:flex; align-items:center; justify-content:center;">
        <div style="background:white; padding:30px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.3); text-align:center; max-width:400px; width:90%;">
            <h2 style="color:#2d5016; margin-bottom:20px;">ğŸ€„ éº»é›€ã‚¹ã‚³ã‚¢ã‚·ãƒ¼ãƒˆ ğŸ€„</h2>
            <p style="color:#666; margin-bottom:20px;">ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</p>
            <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" 
                style="width:100%; padding:12px; border:2px solid #2d5016; border-radius:8px; font-size:16px; margin-bottom:15px;">
            <button onclick="checkPassword()" 
                style="width:100%; background:linear-gradient(135deg, #c41e3a 0%, #9a1529 100%); color:white; border:none; padding:12px; border-radius:8px; font-size:16px; font-weight:bold; cursor:pointer;">
                ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <p id="passwordError" style="color:#c41e3a; margin-top:10px; font-size:14px;"></p>
        </div>
    </div>

    <script>
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãƒã‚§ãƒƒã‚¯
        const PASSWORD = 'kicha2714';
        const AUTH_DURATION = 2 * 60 * 60 * 1000; // 2æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
        
        function checkAuth() {
            const authData = sessionStorage.getItem('mahjong-auth');
            if (!authData) return false;
            
            try {
                const { timestamp } = JSON.parse(authData);
                const now = Date.now();
                // 2æ™‚é–“ä»¥å†…ãªã‚‰OK
                if (now - timestamp < AUTH_DURATION) {
                    updateAuthTimestamp();
                    return true;
                }
            } catch (e) {
                console.error('Auth check error:', e);
            }
            
            return false;
        }
        
        function saveAuth() {
            sessionStorage.setItem('mahjong-auth', JSON.stringify({
                timestamp: Date.now()
            }));
        }
        
        function updateAuthTimestamp() {
            sessionStorage.setItem('mahjong-auth', JSON.stringify({
                timestamp: Date.now()
            }));
        }
        
        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');
            
            if (input.value === PASSWORD) {
                saveAuth();
                document.getElementById('passwordOverlay').style.display = 'none';
                error.textContent = '';
            } else {
                error.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                input.value = '';
                input.focus();
            }
        }
        
        // Enterã‚­ãƒ¼ã§ã‚‚ãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®èªè¨¼ãƒã‚§ãƒƒã‚¯
        if (checkAuth()) {
            document.getElementById('passwordOverlay').style.display = 'none';
        } else {
            document.getElementById('passwordInput').focus();
        }
    </script>

    <div class="container">
        <h1>ğŸ€„ éº»é›€ã‚¹ã‚³ã‚¢ã‚·ãƒ¼ãƒˆ ğŸ€„</h1>
        <h2 style="text-align:center; color:#2d5016; margin-bottom:15px; font-size:18px;">ã€œ Tãƒªãƒ¼ã‚°å°‚ç”¨ ã€œ</h2>

        <!-- é †ä½è¡¨ -->
        <div class="section">
            <h3 class="section-title">ğŸ“Š é †ä½è¡¨</h3>
            <div class="ranking-tabs">
                <div class="ranking-tab active" onclick="switchRankingTab('today')">æœ¬æ—¥</div>
                <div class="ranking-tab" onclick="switchRankingTab('total')">å…¨ä½“</div>
            </div>
            <div id="rankingList"></div>
        </div>

        <!-- å¯¾å±€å…¥åŠ› -->
        <div class="section">
            <h3 class="section-title">âœï¸ å¯¾å±€çµæœå…¥åŠ›</h3>
            <div class="input-grid">
                <div class="input-item">
                    <label>ğŸ¦ã‚¸ã‚§ãƒƒãƒ„è¥¿æ–¹ğŸ¦</label>
                    <input type="number" id="score1" placeholder="ç‚¹æ•°ã‚’å…¥åŠ›" step="100">
                    <div class="yakuman-check">
                        <div>
                            <input type="checkbox" id="yakuman1">
                            <label for="yakuman1">å½¹æº€</label>
                        </div>
                        <div>
                            <input type="checkbox" id="tobashi1">
                            <label for="tobashi1">é£›ã°ã—</label>
                        </div>
                        <div>
                            <input type="checkbox" id="tobi1">
                            <label for="tobi1">é£›ã³</label>
                        </div>
                    </div>
                </div>
                <div class="input-item">
                    <label>ğŸºãƒ“ãƒ¼ã‚¹ãƒˆé«˜æ©‹ğŸº</label>
                    <input type="number" id="score2" placeholder="ç‚¹æ•°ã‚’å…¥åŠ›" step="100">
                    <div class="yakuman-check">
                        <div>
                            <input type="checkbox" id="yakuman2">
                            <label for="yakuman2">å½¹æº€</label>
                        </div>
                        <div>
                            <input type="checkbox" id="tobashi2">
                            <label for="tobashi2">é£›ã°ã—</label>
                        </div>
                        <div>
                            <input type="checkbox" id="tobi2">
                            <label for="tobi2">é£›ã³</label>
                        </div>
                    </div>
                </div>
                <div class="input-item">
                    <label>ğŸ¥Šãƒ•ã‚¡ã‚¤ãƒˆå¤§ç”°ğŸ¥Š</label>
                    <input type="number" id="score3" placeholder="ç‚¹æ•°ã‚’å…¥åŠ›" step="100">
                    <div class="yakuman-check">
                        <div>
                            <input type="checkbox" id="yakuman3">
                            <label for="yakuman3">å½¹æº€</label>
                        </div>
                        <div>
                            <input type="checkbox" id="tobashi3">
                            <label for="tobashi3">é£›ã°ã—</label>
                        </div>
                        <div>
                            <input type="checkbox" id="tobi3">
                            <label for="tobi3">é£›ã³</label>
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn" onclick="addGame()">å¯¾å±€ã‚’è¨˜éŒ²</button>
        </div>

        <!-- å¯¾å±€å±¥æ­´ -->
        <div class="section">
            <h3 class="section-title">ğŸ“œ å¯¾å±€å±¥æ­´</h3>
            <div class="tabs-container" id="tabsContainer"></div>
            <div class="history-table-container">
                <table class="history-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>åŠè˜</th>
                            <th>ğŸ¦è¥¿æ–¹</th>
                            <th>ğŸºé«˜æ©‹</th>
                            <th>ğŸ¥Šå¤§ç”°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="historyList">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆ -->
        <div class="section">
            <h3 class="section-title">ğŸ’° æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—</h3>
            
            <div class="input-grid">
                <div class="input-item">
                    <label>ã‚²ãƒ¼ãƒ ä»£</label>
                    <input type="number" id="tableFee" placeholder="ä¾‹ï¼š6000">
                </div>

            <div class="input-item">
                <label>æ”¯æ‰•ã„è€…</label>
                <select id="payer" 
                    style="padding:15px; font-size:18px; border:2px solid #2d5016; border-radius:12px; width:100%;">
                    <option value="0">ğŸ¦ã‚¸ã‚§ãƒƒãƒ„è¥¿æ–¹ğŸ¦</option>
                    <option value="1">ğŸºãƒ“ãƒ¼ã‚¹ãƒˆé«˜æ©‹ğŸº</option>
                    <option value="2">ğŸ¥Šãƒ•ã‚¡ã‚¤ãƒˆå¤§ç”°ğŸ¥Š</option>
                </select>
            </div>
        <button class="btn" onclick="calcFinalPoints()">ãƒã‚§ãƒƒã‚¯</button>
        <div id="finalPointsResult" style="margin-top:15px;"></div>
        <div id="paypayLinkBlock" class="paypay-block" aria-live="polite"></div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        const players = ['ğŸ¦ã‚¸ã‚§ãƒƒãƒ„è¥¿æ–¹ğŸ¦', 'ğŸºãƒ“ãƒ¼ã‚¹ãƒˆé«˜æ©‹ğŸº', 'ğŸ¥Šãƒ•ã‚¡ã‚¤ãƒˆå¤§ç”°ğŸ¥Š'];
        const shortNames = players.map(p => {
            const chars = Array.from(p);  // çµµæ–‡å­—ã‚’æ­£ã—ãæ‰±ã†ãŸã‚ã«é…åˆ—åŒ–
            const emojiStart = chars[0];   // æœ€åˆã®æ–‡å­—ï¼ˆçµµæ–‡å­—ï¼‰
            const emojiEnd = chars[chars.length - 1];   // æœ€å¾Œã®æ–‡å­—ï¼ˆçµµæ–‡å­—ï¼‰
            const name = p.replace(/.*(è¥¿æ–¹|é«˜æ©‹|å¤§ç”°).*/, "$1"); // åå­—æŠ½å‡º
            return `${emojiStart}${name}${emojiEnd}`;
        });

        let sections = []; // ç¯€ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ [{games: [...]}]
        let currentSectionIndex = 0; // ç¾åœ¨è¡¨ç¤ºä¸­ã®ç¯€ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        let rankingMode = 'today'; // 'today' or 'total'

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        function loadData() {
            const saved = localStorage.getItem('tleague-sections');
            if (saved) {
                sections = JSON.parse(saved);
                if (sections.length === 0) {
                    // åˆå›ã¯ç¬¬1ç¯€ã‚’ä½œæˆ
                    sections.push({ games: [] });
                }
                currentSectionIndex = sections.length - 1; // æœ€æ–°ã®ç¯€ã‚’è¡¨ç¤º
            } else {
                // åˆå›ã¯ç¬¬1ç¯€ã‚’ä½œæˆ
                sections = [{ games: [] }];
                currentSectionIndex = 0;
            }
            updateRanking();
            updateHistory();
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        function saveData() {
            localStorage.setItem('tleague-sections', JSON.stringify(sections));
        }

        // ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—é–¢æ•°
        function calculatePoints(scores, yakumanFlags, tobashiFlags, tobiFlags) {
            // 40000ã‚’å¼•ã„ã¦1000ã§å‰²ã‚‹
            const basePoints = scores.map(score => (score - 40000) / 1000);
            
            // ãƒã‚¤ãƒ³ãƒˆã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒšã‚¢ã«ã—ã¦ä¿å­˜
            const pointsWithIndex = basePoints.map((point, index) => ({ point, index, score: scores[index] }));
            
            // ãƒã‚¤ãƒ³ãƒˆã§é™é †ã‚½ãƒ¼ãƒˆï¼ˆé«˜ã„é †ï¼‰
            pointsWithIndex.sort((a, b) => b.point - a.point);
            
            const finalPoints = [0, 0, 0];
            
            const firstPoint = pointsWithIndex[0].point;
            const secondPoint = pointsWithIndex[1].point;
            const thirdPoint = pointsWithIndex[2].point;
            
            const firstIndex = pointsWithIndex[0].index;
            const secondIndex = pointsWithIndex[1].index;
            const thirdIndex = pointsWithIndex[2].index;
            
            // 2ä½ã¨3ä½ãŒåŒç‚¹ã®å ´åˆ
            if (secondPoint === thirdPoint) {
                // 3ä½ã®ãƒšãƒŠãƒ«ãƒ†ã‚£-10ã‚’2äººã§åˆ†å‰² â†’ -5ãšã¤
                finalPoints[secondIndex] = secondPoint - 5;
                finalPoints[thirdIndex] = thirdPoint - 5;
                
                // 1ä½ã¯2ä½ã¨3ä½ã®åˆè¨ˆã®é€†æ•°
                finalPoints[firstIndex] = -(finalPoints[secondIndex] + finalPoints[thirdIndex]);
                
            } else {
                // é€šå¸¸ã®å‡¦ç†
                finalPoints[firstIndex] = firstPoint;
                finalPoints[secondIndex] = secondPoint;
                finalPoints[thirdIndex] = thirdPoint - 10; // 3ç€ã¯-10
                
                // 1ä½ã¯2ä½ã¨3ä½ã®åˆè¨ˆã®é€†æ•°ï¼ˆ0ã«ãªã‚‹ã‚ˆã†ã«ï¼‰
                finalPoints[firstIndex] = -(finalPoints[secondIndex] + finalPoints[thirdIndex]);
            }
            
            // é£›ã³ã®å‡¦ç†
            const tobiCount = tobiFlags.filter(x => x).length;
            tobiFlags.forEach((isTobi, index) => {
                if (isTobi) {
                    // é£›ã°ã•ã‚ŒãŸäººã¯-10
                    finalPoints[index] -= 10;
                }
            });
            
            // é£›ã°ã—ã®å‡¦ç†
            const tobashiCount = tobashiFlags.filter(x => x).length;
            if (tobashiCount > 0 && tobiCount > 0) {
                const bonusPerTobashi = (tobiCount * 10) / tobashiCount;
                tobashiFlags.forEach((isTobashi, index) => {
                    if (isTobashi) {
                        // é£›ã°ã—ãƒœãƒ¼ãƒŠã‚¹ã‚’åˆ†é…
                        finalPoints[index] += bonusPerTobashi;
                    }
                });
            }
            
            // å½¹æº€ã®å‡¦ç†
            yakumanFlags.forEach((hasYakuman, index) => {
                if (hasYakuman) {
                    // å½¹æº€ã‚’ä¸ŠãŒã£ãŸäººã«+40
                    finalPoints[index] += 40;
                    // æ®‹ã‚Šã®äºŒäººã‹ã‚‰-20ãšã¤
                    for (let i = 0; i < 3; i++) {
                        if (i !== index) {
                            finalPoints[i] -= 20;
                        }
                    }
                }
            });
            
            return finalPoints;
        }

        // å¯¾å±€ã‚’è¿½åŠ 
        function addGame() {
            const score1 = parseInt(document.getElementById('score1').value);
            const score2 = parseInt(document.getElementById('score2').value);
            const score3 = parseInt(document.getElementById('score3').value);

            if (isNaN(score1) || isNaN(score2) || isNaN(score3)) {
                alert('ã™ã¹ã¦ã®ç‚¹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // åˆè¨ˆ105000ãƒã‚§ãƒƒã‚¯
            const sum = score1 + score2 + score3;
            if (sum !== 105000) {
                alert(`3äººã®ç‚¹æ•°ã®åˆè¨ˆãŒ 105000 ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆç¾åœ¨: ${sum}ï¼‰`);
                return;
            }


            const scores = [score1, score2, score3];
            const yakumanFlags = [
                document.getElementById('yakuman1').checked,
                document.getElementById('yakuman2').checked,
                document.getElementById('yakuman3').checked
            ];
            const tobashiFlags = [
                document.getElementById('tobashi1').checked,
                document.getElementById('tobashi2').checked,
                document.getElementById('tobashi3').checked
            ];
            const tobiFlags = [
                document.getElementById('tobi1').checked,
                document.getElementById('tobi2').checked,
                document.getElementById('tobi3').checked
            ];
            
            // é£›ã°ã—ã¨é£›ã³ã®1å¯¾1å¯¾å¿œãƒã‚§ãƒƒã‚¯
            const tobashiCount = tobashiFlags.filter(x => x).length;
            const tobiCount = tobiFlags.filter(x => x).length;
            
            if (tobashiCount !== tobiCount) {
                alert(`ã€Œé£›ã°ã—ã€ã¨ã€Œé£›ã³ã€ã¯1å¯¾1ã§å¯¾å¿œã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™\nç¾åœ¨ï¼šé£›ã°ã— ${tobashiCount}äººã€é£›ã³ ${tobiCount}äºº`);
                return;
            }
            
            const points = calculatePoints(scores, yakumanFlags, tobashiFlags, tobiFlags);

            const gameData = {
                scores: scores,
                points: points,
                yakumanFlags: yakumanFlags,
                tobashiFlags: tobashiFlags,
                tobiFlags: tobiFlags,
                timestamp: Date.now()
            };

            // æœ€æ–°ã®ç¯€ã«è¿½åŠ 
            if (sections.length === 0) {
                sections.push({ games: [] });
            }
            sections[sections.length - 1].games.push(gameData);
            
            saveData();
            
            // æœ€æ–°ã®ç¯€ã‚’è¡¨ç¤º
            currentSectionIndex = sections.length - 1;
            
            updateRanking();
            updateHistory();

            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('score1').value = '';
            document.getElementById('score2').value = '';
            document.getElementById('score3').value = '';
            document.getElementById('yakuman1').checked = false;
            document.getElementById('yakuman2').checked = false;
            document.getElementById('yakuman3').checked = false;
            document.getElementById('tobashi1').checked = false;
            document.getElementById('tobashi2').checked = false;
            document.getElementById('tobashi3').checked = false;
            document.getElementById('tobi1').checked = false;
            document.getElementById('tobi2').checked = false;
            document.getElementById('tobi3').checked = false;
        }

        // å¯¾å±€ã‚’å‰Šé™¤
        function deleteGame(sectionIndex, gameIndex) {
            if (confirm('ã“ã®å¯¾å±€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                sections[sectionIndex].games.splice(gameIndex, 1);
                
                if (sections[sectionIndex].games.length === 0 && sections.length > 1) {
                    sections.splice(sectionIndex, 1);
                    if (currentSectionIndex >= sections.length) {
                        currentSectionIndex = sections.length - 1;
                    }
                }
                saveData();
                updateRanking();
                updateHistory();
            }
        }
        function editGame(sectionIndex, gameIndex) {
            const game = sections[sectionIndex].games[gameIndex];
            
            const newScores = game.scores.map((s, i) =>
                parseInt(prompt(`${players[i]} ã®ç‚¹æ•°ã‚’å…¥åŠ›`, s))
            );
        
        if (newScores.some(s => isNaN(s))) {
            alert("æ­£ã—ã„ç‚¹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }
        
        if (newScores[0] + newScores[1] + newScores[2] !== 105000) {
            alert("3äººã®ç‚¹æ•°ã®åˆè¨ˆãŒ 105000 ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }
        
        const newPoints = calculatePoints(
            newScores,
            game.yakumanFlags,
            game.tobashiFlags,
            game.tobiFlags
        );
        
        game.scores = newScores;
        game.points = newPoints;
        
        saveData();
        updateHistory();
        updateRanking();
    }


        // æ–°ã—ã„ç¯€ã‚’è¿½åŠ 
        function addNewSection() {
            if (confirm('æ–°ã—ã„ç¯€ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) {
                sections.push({ games: [] });
                currentSectionIndex = sections.length - 1;
                saveData();
                updateHistory();
            }
        }

        // é †ä½è¡¨ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
        function switchRankingTab(mode) {
            rankingMode = mode;
            
            // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            const tabs = document.querySelectorAll('.ranking-tab');
            tabs.forEach(tab => {
                if ((mode === 'today' && tab.textContent === 'æœ¬æ—¥') ||
                    (mode === 'total' && tab.textContent === 'å…¨ä½“')) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            updateRanking();
        }

        // é †ä½è¡¨ã‚’æ›´æ–°
        function updateRanking() {
            const totalPoints = [0, 0, 0];
            
            if (rankingMode === 'today') {
                // æœ¬æ—¥ï¼šæœ€æ–°ã®ç¯€ã®ã¿
                if (sections.length > 0) {
                    const currentSection = sections[sections.length - 1];
                    currentSection.games.forEach(game => {
                        game.points.forEach((point, index) => {
                            totalPoints[index] += point;
                        });
                    });
                }
            } else {
                // å…¨ä½“ï¼šå…¨ã¦ã®ç¯€
                sections.forEach(section => {
                    section.games.forEach(game => {
                        game.points.forEach((point, index) => {
                            totalPoints[index] += point;
                        });
                    });
                });
            }

            // é †ä½ã‚’æ±ºå®š
            const ranking = totalPoints.map((points, index) => ({
                name: players[index],
                points: points,
                index: index
            }));

            ranking.sort((a, b) => b.points - a.points);

            // é †ä½è¡¨ã‚’è¡¨ç¤º
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';

            ranking.forEach((player, rank) => {
                const rankClass = rank === 0 ? 'first' : rank === 1 ? 'second' : 'third';
                const item = document.createElement('div');
                item.className = `ranking-item ${rankClass}`;
                item.innerHTML = `
                    <span class="rank-number">${rank + 1}ä½</span>
                    <span class="player-name">${player.name}</span>
                    <span class="player-points">${player.points > 0 ? '+' : ''}${player.points}</span>
                `;
                rankingList.appendChild(item);
            });
        }

        // å±¥æ­´ã‚’æ›´æ–°
        function updateHistory() {
            const historyList = document.getElementById('historyList');
            const tabsContainer = document.getElementById('tabsContainer');
            
            historyList.innerHTML = '';
            tabsContainer.innerHTML = '';

            if (sections.length === 0) {
                historyList.innerHTML = '<tr><td colspan="5" style="padding: 20px; color: #666;">ã¾ã å¯¾å±€ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            // ã‚¿ãƒ–ã‚’ç”Ÿæˆ
            sections.forEach((section, index) => {
                const tab = document.createElement('div');
                tab.className = `tab ${index === currentSectionIndex ? 'active' : ''}`;
                tab.textContent = `ç¬¬${index + 1}ç¯€`;
                tab.onclick = () => {
                    currentSectionIndex = index;
                    updateHistory();
                };
                tabsContainer.appendChild(tab);
            });

            // æ–°ã—ã„ç¯€ã‚’è¿½åŠ ã™ã‚‹ãƒœã‚¿ãƒ³
            const addBtn = document.createElement('button');
            addBtn.className = 'add-section-btn';
            addBtn.textContent = '+ æ–°ã—ã„ç¯€';
            addBtn.onclick = addNewSection;
            tabsContainer.appendChild(addBtn);

            // ç¾åœ¨ã®ç¯€ã®å¯¾å±€ã‚’å–å¾—
            const currentSection = sections[currentSectionIndex];
            
            if (!currentSection || currentSection.games.length === 0) {
                historyList.innerHTML = '<tr><td colspan="5" style="padding: 20px; color: #666;">ã“ã®ç¯€ã«ã¯ã¾ã å¯¾å±€ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            // è¡¨ã®è¡Œã‚’ç”Ÿæˆ
            currentSection.games.forEach((game, gameIndex) => {
                const row = document.createElement('tr');
                
                // åŠè˜ç•ªå·
                const gameNumCell = document.createElement('td');
                gameNumCell.textContent = `${gameIndex + 1}`;
                gameNumCell.style.fontWeight = 'bold';
                row.appendChild(gameNumCell);

                // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æƒ…å ±
                players.forEach((name, playerIndex) => {
                    const cell = document.createElement('td');
                    const yakumanBadge = game.yakumanFlags && game.yakumanFlags[playerIndex] 
                        ? '<div class="yakuman-badge">å½¹æº€</div>' 
                        : '';
                    const tobashiBadge = game.tobashiFlags && game.tobashiFlags[playerIndex]
                        ? '<div class="tobashi-badge">é£›ã°ã—</div>'
                        : '';
                    const tobiBadge = game.tobiFlags && game.tobiFlags[playerIndex]
                        ? '<div class="tobi-badge">é£›ã³</div>'
                        : '';
                    
                    cell.innerHTML = `
                        <div class="player-cell">
                            <div class="player-score">${game.scores[playerIndex]}ç‚¹</div>
                            <div class="player-point">${game.points[playerIndex] > 0 ? '+' : ''}${game.points[playerIndex]}</div>
                            ${yakumanBadge}
                            ${tobashiBadge}
                            ${tobiBadge}
                        </div>
                    `;
                    row.appendChild(cell);
                });

                // æ“ä½œã‚»ãƒ«ï¼ˆé‡è¦ï¼šclassNameã‚’è¨­å®šï¼‰
                const actionCell = document.createElement('td');
                actionCell.className = 'action-cell';
                
                // ç·¨é›†ãƒœã‚¿ãƒ³
                const editBtn = document.createElement('button');
                editBtn.textContent = 'ç·¨é›†';
                editBtn.onclick = () => editGame(currentSectionIndex, gameIndex);
                actionCell.appendChild(editBtn);
                
                // å‰Šé™¤ãƒœã‚¿ãƒ³
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'å‰Šé™¤';
                deleteBtn.onclick = () => deleteGame(currentSectionIndex, gameIndex);
                actionCell.appendChild(deleteBtn);
                
                row.appendChild(actionCell);
                historyList.appendChild(row);
            });
        }

        //æœ€çµ‚ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæœ€å°é€ãƒã‚¤ãƒ³ãƒˆå›æ•°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰
        function calcFinalPoints() {
            const fee = parseInt(document.getElementById("tableFee").value);
            if (isNaN(fee) || fee <= 0) {
                alert("ã‚²ãƒ¼ãƒ ä»£ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
        
            // æœ€æ–°ã®ç¯€ã®åˆè¨ˆãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—
            const total = [0, 0, 0];
            const sec = sections[sections.length - 1];
        
            sec.games.forEach(g => {
                g.points.forEach((p, i) => total[i] += p);
            });
        
            // â‘  å…¨å“¡ Ã—50
            const moneyPoints = total.map(x => x * 50);
        
            // â‘¡ ã‚²ãƒ¼ãƒ ä»£ã‚’3ã§å‰²ã‚‹ï¼ˆåˆ‡ã‚Šä¸Šã’ï¼‰
            const feeShare = Math.ceil(fee / 3);
        
            // â‘¢ æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆï¼ˆã‚²ãƒ¼ãƒ ä»£è² æ‹…å‰ï¼‰
            const final = moneyPoints.map(p => p - feeShare);
        
            // å·¦å´ã®ã¿çµµæ–‡å­—ã‚’ã¤ã‘ãŸåå‰ã‚’ç”Ÿæˆ
            const leftEmojiNames = players.map(p => {
                const chars = Array.from(p);
                const emoji = chars[0];
                const name = p.replace(/.*(è¥¿æ–¹|é«˜æ©‹|å¤§ç”°).*/, "$1");
                return `${emoji}${name}`;
            });
        
            // --- æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆè¡¨ã®ç”Ÿæˆ ---
            let html = `
                <table class="history-table">
                    <thead>
                        <tr><th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th><th>æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆ</th></tr>
                    </thead>
                    <tbody>
            `;

            players.forEach((name, i) => {
                html += `<tr><td>${leftEmojiNames[i]}</td><td>${final[i]}</td></tr>`;
            });

            html += `
                    </tbody>
                </table>
                <br>
            `;

            // --- æœ€å°é€ãƒã‚¤ãƒ³ãƒˆå›æ•°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  ---
            const payerIndex = parseInt(document.getElementById("payer").value, 10);
            
            // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è¨ˆç®—
            // æ”¯æ‰•ã„è€…ã¯ç«‹ã¦æ›¿ãˆã¦ã„ã‚‹ã®ã§ã‚²ãƒ¼ãƒ ä»£å…¨é¡ã‚’åŠ ç®—ã€ä»–ã¯è² æ‹…åˆ†ã‚’æ¸›ç®—
            const balances = final.map((pt, i) => {
                if (i === payerIndex) {
                    return pt + fee;  // ç«‹ã¦æ›¿ãˆãŸåˆ†ã‚’åŠ ç®—
                } else {
                    return pt;  // æ—¢ã«feeShareãŒå¼•ã‹ã‚Œã¦ã„ã‚‹
                }
            });
            
            // ãƒãƒ©ãƒ³ã‚¹ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’çµã³ã¤ã‘ãŸé…åˆ—ã‚’ä½œæˆ
            const balanceData = balances.map((balance, index) => ({
                index: index,
                name: leftEmojiNames[index],
                balance: balance
            }));
            
            // é€ãƒã‚¤ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¨ˆç®—
            const transactions = [];
            const workingBalances = balanceData.map(d => ({ ...d }));
            
            while (true) {
                // æœ€ã‚‚å‚µæ¨©ãŒå¤šã„äººï¼ˆãƒ—ãƒ©ã‚¹ãŒå¤§ãã„ï¼‰
                let maxCreditor = null;
                // æœ€ã‚‚è² å‚µãŒå¤šã„äººï¼ˆãƒã‚¤ãƒŠã‚¹ãŒå¤§ãã„ï¼‰
                let maxDebtor = null;
                
                for (const person of workingBalances) {
                    if (maxCreditor === null || person.balance > maxCreditor.balance) {
                        maxCreditor = person;
                    }
                    if (maxDebtor === null || person.balance < maxDebtor.balance) {
                        maxDebtor = person;
                    }
                }
                
                // å…¨å“¡ã®ãƒãƒ©ãƒ³ã‚¹ãŒ0ã«è¿‘ã‘ã‚Œã°çµ‚äº†ï¼ˆèª¤å·®1å††ã¾ã§è¨±å®¹ï¼‰
                if (Math.abs(maxCreditor.balance) < 1 && Math.abs(maxDebtor.balance) < 1) {
                    break;
                }
                
                // é€ãƒã‚¤ãƒ³ãƒˆé¡ã‚’è¨ˆç®—
                const amount = Math.min(maxCreditor.balance, Math.abs(maxDebtor.balance));
                
                if (amount < 1) break;  // 1å††æœªæº€ãªã‚‰çµ‚äº†
                
                // é€ãƒã‚¤ãƒ³ãƒˆã‚’è¨˜éŒ²
                transactions.push({
                    from: maxDebtor.name,
                    to: maxCreditor.name,
                    amount: Math.round(amount)
                });
                
                // ãƒãƒ©ãƒ³ã‚¹ã‚’æ›´æ–°
                maxCreditor.balance -= amount;
                maxDebtor.balance += amount;
            }
            
            // --- é€ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ã®è¡¨ç¤º ---
            html += `<div style="text-align:center; font-size:16px; color:#2d5016; line-height:2; margin-top:10px; padding:15px; background:white; border-radius:8px; border:2px solid #2d5016;">`;
            
            if (transactions.length === 0) {
                html += `<span style="color:#666;">é€ãƒã‚¤ãƒ³ãƒˆã®å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“</span>`;
            } else {
                transactions.forEach(tx => {
                    html += `${tx.from} â¡ï¸ ${tx.to} ã« <span style="color:#c41e3a; font-weight:bold; font-size:18px;">${tx.amount} pt</span><br>`;
                    });
                html += `
                    <a href="paypay://"
                        style="
                            display:inline-block;
                            margin-top:10px;
                            padding:5px 20px;
                            background:#FF0033;
                            color:white;
                            font-weight:bold;
                            border-radius:8px;
                            text-decoration:none;
                        ">
                        PayPayã‚’é–‹ã
                    </a>
                `;
                }
            
            html += `</div>`;

            document.getElementById("finalPointsResult").innerHTML = html;
            updatePayPayBlock(transactions);
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>






