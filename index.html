<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»é›€ã‚¹ã‚³ã‚¢ã‚·ãƒ¼ãƒˆ</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #2d5016 0%, #1a3d0a 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 15px;
        }

        h1 {
            text-align: center;
            color: #c41e3a;
            margin-bottom: 20px;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .section {
            background: #e8f5e9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #2d5016;
        }

        .section-title {
            color: #2d5016;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ios-button {
            background: #666666;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s ease;
            white-space: nowrap;
        }
        
        .ios-button:hover {
            opacity: 0.8;
        }
        
        .ios-button:active {
            opacity: 0.6;
        }

        .ranking-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .ranking-tab {
            background: white;
            border: 2px solid #2d5016;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #2d5016;
            font-size: 14px;
        }

        .ranking-tab:hover {
            background: #e8f5e9;
        }

        .ranking-tab.active {
            background: linear-gradient(135deg, #2d5016 0%, #1a3d0a 100%);
            color: white;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 2px solid #2d5016;
        }

        .ranking-item.first {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border: 3px solid #daa520;
        }

        .ranking-item.second {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            border: 3px solid #a8a8a8;
        }

        .ranking-item.third {
            background: linear-gradient(135deg, #cd7f32 0%, #e8a562 100%);
            border: 3px solid #b8732d;
        }

        .rank-number {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            min-width: 35px;
        }

        .player-name {
            font-size: 14px;
            font-weight: bold;
            color: #2d5016;
            flex: 1;
            margin-left: 10px;
            white-space: nowrap;
            padding-right: 10px;
            border-right: 3px solid rgba(45, 80, 22, 0.3);
        }

        .player-points {
            font-size: 18px;
            font-weight: bold;
            color: #c41e3a;
            margin-left: 10px;
            min-width: 50px;
            text-align: right;
        }

        .input-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }

        .input-item {
            display: flex;
            flex-direction: column;
        }

        .input-item label {
            font-weight: bold;
            color: #2d5016;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .input-item input {
            padding: 10px;
            border: 2px solid #2d5016;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: white;
        }

        .input-item input:focus {
            outline: none;
            border-color: #c41e3a;
        }

        .yakuman-check {
            display: flex;
            align-items: center;
            margin-top: 5px;
            gap: 8px;
            flex-wrap: wrap;
        }

        .yakuman-check > div {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .yakuman-check input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #c41e3a;
        }

        .yakuman-check label {
            margin: 0;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            color: #c41e3a;
        }

        .btn {
            background: linear-gradient(135deg, #c41e3a 0%, #9a1529 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(196, 30, 58, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .tabs-container {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .tab {
            background: white;
            border: 2px solid #2d5016;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #2d5016;
            font-size: 13px;
        }

        .tab:hover {
            background: #e8f5e9;
        }

        .tab.active {
            background: linear-gradient(135deg, #2d5016 0%, #1a3d0a 100%);
            color: white;
        }

        .add-section-btn {
            background: linear-gradient(135deg, #c41e3a 0%, #9a1529 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .add-section-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(196, 30, 58, 0.4);
        }

        .history-table-container {
            overflow-x: auto;
        }

        .history-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #2d5016;
            border-collapse: collapse;
        }

        .history-table th {
            background: linear-gradient(135deg, #2d5016 0%, #1a3d0a 100%);
            color: white;
            padding: 6px 5px;
            text-align: center;
            font-size: 11px;
            border: 1px solid #1a3d0a;
            height: 30px !important;
        }

        .history-table td {
            padding: 8px 5px;
            text-align: center;
            border: 1px solid #e0e0e0;
            font-size: 12px;
            min-height: 180px !important;
            vertical-align: middle;
        }
        
        .history-table tbody tr {
            min-height: 180px !important;
        }

        .history-table tr:nth-child(even) {
            background: #f5f5f5;
        }

        .history-table tr:hover {
            background: #e8f5e9;
        }

        .player-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 3px;
        }

        .player-score {
            font-size: 11px;
            color: #666;
        }

        .player-point {
            font-weight: bold;
            font-size: 13px;
            color: #c41e3a;
        }
        
        .action-cell {
            position: relative !important;
            padding: 0 !important;
            white-space: normal !important;
            min-height: 60px !important;
            background: transparent !important;
        }

        .yakuman-badge {
            background: #c39000;
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 3px;
            margin-top: 2px;
            display: inline-block;
            font-weight: bold;
        }

        .tobashi-badge {
            background: #c41e3a;
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 3px;
            margin-top: 2px;
            display: inline-block;
            font-weight: bold;
        }

        .tobi-badge {
            background: #2d5016;
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 3px;
            margin-top: 2px;
            display: inline-block;
            font-weight: bold;
        }

        .double-yakuman-badge {
            background: #00008b;
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 3px;
            margin-top: 2px;
            display: inline-block;
            font-weight: bold;
        }

        .double-tobashi-badge {
            background: #800080;
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 3px;
            margin-top: 2px;
            display: inline-block;
            font-weight: bold;
        }

        .triple-yakuman-badge {
            background: #000000;
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
            font-weight: bold;
        }

        .no-badge {
            background: #cccccc;
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 3px;
            margin-top: 2px;
            display: inline-block;
            font-weight: bold;
        }


        /* ==== å¯¾å±€å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šã‚¹ãƒãƒ›æœ€é©åŒ–ï¼ˆiPhone13 mini å®Œå…¨å¯¾å¿œï¼‰ ==== */
        /* æ”¹è¡Œç¦æ­¢ï¼‹ä½™ç™½ã‚’è©°ã‚ã‚‹ */
        .history-table th,
        .history-table td {
            white-space: nowrap;
            padding: 4px !important;
        }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®åˆ—å¹…å›ºå®šåŒ– */
        .history-table {
            table-layout: fixed;
            width: 100%;
        }
        
        /* åŠè˜åˆ—ï¼ˆæ”¹è¡Œãªã—ï¼†å°ã•ãå›ºå®šï¼‰ */
        .history-table th:nth-child(1) {
            width: 30px !important;
            min-width: 30px !important;
            max-width: 30px !important;
            height: 30px !important;
        }
        
        .history-table td:nth-child(1) {
            width: 30px !important;
            min-width: 30px !important;
            max-width: 30px !important;
            min-height: 180px !important;
        }
        
        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3åˆ—ï¼ˆå‡ç­‰å¹…ã§æ”¹è¡Œãªã—ï¼‰ */
        .history-table th:nth-child(2),
        .history-table th:nth-child(3),
        .history-table th:nth-child(4) {
            width: 70px !important;
            min-width: 70px !important;
            max-width: 70px !important;
            height: 30px !important;
        }
        
        .history-table td:nth-child(2),
        .history-table td:nth-child(3),
        .history-table td:nth-child(4) {
            vertical-align: top !important;
            width: 70px !important;
            min-width: 70px !important;
            max-width: 70px !important;
            min-height: 180px !important;
        }

        /* å¯¾å±€å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã ã‘ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3åˆ—ã‚’ä¸Šè©°ã‚ï¼†180px ã«ã™ã‚‹ */
        .history-table:not(.final-points-table) td:nth-child(2),
        .history-table:not(.final-points-table) td:nth-child(3),
        .history-table:not(.final-points-table) td:nth-child(4),
        .history-table:not(.final-points-table) td:nth-child(5){
            vertical-align: top !important;
            width: 70px !important;
            min-width: 70px !important;
            max-width: 70px !important;
            min-height: 180px !important;}
        
        /* æ“ä½œåˆ—ï¼ˆç´°ã„åˆ—å¹…ã§å›ºå®šï¼‰ */
        .history-table th:nth-child(5) {
            width: auto !important;
            min-width: 40px !important;
            height: 30px !important;
            vertical-align: middle !important;
            border-left: none !important;
            border-right: none !important;
            padding: 6px 5px !important;
        }
        
        .history-table td:nth-child(5) {
            width: auto !important;
            min-width: 40px !important;
            vertical-align: middle !important;
            padding: 0 !important;
        }

        /* åˆè¨ˆè¡Œã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3åˆ—ã ã‘ã¯ä¸Šä¸‹ä¸­å¤®ã«ã™ã‚‹ */
        .history-table tr.total-row td:nth-child(2),
        .history-table tr.total-row td:nth-child(3),
        .history-table tr.total-row td:nth-child(4) {
            vertical-align: middle !important;
        }
        
        /* åˆè¨ˆè¡Œã®ä¸­èº«ï¼ˆplayer-cellï¼‰ã‚‚ã‚»ãƒ«ã®é«˜ã•ã«åˆã‚ã›ã¦ä¸­å¤®å¯„ã› */
        .history-table tr.total-row td .player-cell {
            height: 100%;
            justify-content: center;
        }
        
        /* æ“ä½œã‚»ãƒ«å†…ã®ãƒœã‚¿ãƒ³ï¼ˆç¸¦ä¸¦ã³ï¼‹ä½™ç™½ã‚ã‚Šï¼‹å°å‹åŒ–ï¼‰ */
        .action-cell button {
            position: absolute !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: 40px !important;
            height: 20px !important;
            padding: 0 !important;
            font-size: 10px !important;
            line-height: 20px !important;
            margin: 0 !important;
            border: 1px solid #2d5016;
            border-radius: 4px;
            background: white;
            color: #2d5016;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .action-cell button:hover {
            background: #e8f5e9;
            transform: translateX(-50%) scale(1.05) !important;
        }

        .action-cell button:active {
            transform: translateX(-50%) scale(0.95) !important;
        }

        .paypay-block {
            margin-top: 20px;
            padding: 18px;
            border-radius: 16px;
            background: #ff0033;
            color: #fff;
            text-align: center;
            display: none;
            gap: 12px;
            flex-direction: column;
            align-items: center;
        }

        .paypay-block__title {
            margin: 0 0 6px;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.08em;
        }

        .paypay-button {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 12px 16px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.18);
            color: #fff;
            text-decoration: none;
            font-weight: 700;
            letter-spacing: 0.04em;
            border: 2px solid rgba(255, 255, 255, 0.35);
            transition: background 0.2s ease;
        }

        .paypay-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .paypay-button--disabled {
            cursor: not-allowed;
            opacity: 0.7;.history-table
            text-decoration: none;
        }
        /* ==== æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆè¡¨ã®ã‚¹ã‚¿ã‚¤ãƒ« ==== */
        .final-points-table th:nth-child(1),
        .final-points-table td:nth-child(1) {
            width: 60px !important;
            min-width: 60px !important;
            max-width: 60px !important;
            text-align: center !important;
            vertical-align: middle !important;
        }
        
        .final-points-table th:nth-child(2),
        .final-points-table td:nth-child(2) {
            width: 45px !important;
            min-width: 45px !important;
            max-width: 45px !important;
            text-align: center !important;
            vertical-align: middle !important;
        }
        
        .final-points-table th:nth-child(3),
        .final-points-table td:nth-child(3) {
            width: 45px !important;
            min-width: 45px !important;
            max-width: 45px !important;
            text-align: center !important;
            vertical-align: middle !important;
        }
        
        .final-points-table th:nth-child(4),
        .final-points-table td:nth-child(4) {
            width: 45px !important;
            min-width: 45px !important;
            max-width: 45px !important;
            text-align: center !important;
            vertical-align: middle !important;
        }
        
        .final-points-table th:nth-child(5),
        .final-points-table td:nth-child(5) {
            width: auto !important;
            text-align: center !important;
            vertical-align: middle !important;
            font-weight: bold;
        }
        
        .final-points-table th,
        .final-points-table td {
            white-space: nowrap;
            text-align: center;
            vertical-align: middle !important;
        }

        /* æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆè¡¨ã§ã¯ã€å¯¾å±€å±¥æ­´ç”¨ã®ã€Œä¸Šè©°ã‚180pxã€ã‚’æ‰“ã¡æ¶ˆã™ */
        .final-points-table td:nth-child(2),
        .final-points-table td:nth-child(3),
        .final-points-table td:nth-child(4),
        .final-points-table td:nth-child(5){
            vertical-align: middle !important;  /* ä¸Šæ›¸ã */
            min-height: auto !important;        /* 180px ã‚’è§£é™¤ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
        }
        
        /* ã¤ã„ã§ã«ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã‚‚æ¨™æº–ã®é«˜ã•ã§OKãªã‚‰ */
        .final-points-table td,
        .final-points-table th {
            height: auto !important;
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 20000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .custom-alert-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            overflow: hidden;
        }
        
        .custom-alert-header {
            background: #c41e3a;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 16px;
        }
        
        .custom-alert-body {
            padding: 20px;
            color: #333;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .custom-alert-footer {
            padding: 15px 20px;
            text-align: right;
            border-top: 1px solid #e0e0e0;
        }
        
        .custom-alert-button {
            background: linear-gradient(135deg, #c41e3a 0%, #9a1529 100%);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .custom-alert-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(196, 30, 58, 0.4);
        }
        
        .custom-alert-button:active {
            transform: translateY(0);
        }
        
        /* ã‚¨ãƒ©ãƒ¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯æœ€å‰é¢ã« */
        #customAlertOverlay {
            z-index: 30000;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="passwordOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, #2d5016 0%, #1a3d0a 100%); z-index:10000; display:flex; align-items:center; justify-content:center;">
        <div style="background:white; padding:30px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.3); text-align:center; max-width:400px; width:90%;">
            <h2 style="color:#2d5016; margin-bottom:20px;">ğŸ€„ éº»é›€ã‚¹ã‚³ã‚¢ã‚·ãƒ¼ãƒˆ ğŸ€„</h2>
            <p style="color:#666; margin-bottom:20px;">ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</p>
            <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" 
                style="width:100%; padding:12px; border:2px solid #2d5016; border-radius:8px; font-size:16px; margin-bottom:15px;">
            <button onclick="checkPassword()" 
                style="width:100%; background:linear-gradient(135deg, #c41e3a 0%, #9a1529 100%); color:white; border:none; padding:12px; border-radius:8px; font-size:16px; font-weight:bold; cursor:pointer;">
                ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <p id="passwordError" style="color:#c41e3a; margin-top:10px; font-size:14px;"></p>
        </div>
    </div>

    <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div id="customAlertOverlay" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <div class="custom-alert-header" id="customAlertTitle">ã‚¨ãƒ©ãƒ¼</div>
            <div class="custom-alert-body" id="customAlertMessage"></div>
            <div class="custom-alert-footer">
                <button class="custom-alert-button" onclick="closeCustomAlert()">OK</button>
            </div>
        </div>
    </div>
    <!-- ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div id="editDialogOverlay" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <div class="custom-alert-header">å¯¾å±€çµæœã‚’ç·¨é›†</div>
            <div class="custom-alert-body">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="font-weight: bold; color: #2d5016; display: block; margin-bottom: 5px;">ğŸ›¡ï¸è¥¿æ–¹</label>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label style="font-size: 12px; color: #666;">ç‚¹æ•°</label>
                                <input type="number" id="editScore1" style="width: 100%; padding: 8px; border: 2px solid #2d5016; border-radius: 6px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 12px; color: #666;">ãƒã‚¤ãƒ³ãƒˆ</label>
                                <input type="number" id="editPoint1" style="width: 100%; padding: 8px; border: 2px solid #2d5016; border-radius: 6px;">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label style="font-weight: bold; color: #2d5016; display: block; margin-bottom: 5px;">ğŸºé«˜æ©‹</label>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label style="font-size: 12px; color: #666;">ç‚¹æ•°</label>
                                <input type="number" id="editScore2" style="width: 100%; padding: 8px; border: 2px solid #2d5016; border-radius: 6px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 12px; color: #666;">ãƒã‚¤ãƒ³ãƒˆ</label>
                                <input type="number" id="editPoint2" style="width: 100%; padding: 8px; border: 2px solid #2d5016; border-radius: 6px;">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label style="font-weight: bold; color: #2d5016; display: block; margin-bottom: 5px;">ğŸ²å¤§ç”°</label>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label style="font-size: 12px; color: #666;">ç‚¹æ•°</label>
                                <input type="number" id="editScore3" style="width: 100%; padding: 8px; border: 2px solid #2d5016; border-radius: 6px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 12px; color: #666;">ãƒã‚¤ãƒ³ãƒˆ</label>
                                <input type="number" id="editPoint3" style="width: 100%; padding: 8px; border: 2px solid #2d5016; border-radius: 6px;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="custom-alert-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="custom-alert-button" style="background: #999;" onclick="closeEditDialog()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="custom-alert-button" onclick="saveEditedGame()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div id="deleteDialogOverlay" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <div class="custom-alert-header">å¯¾å±€ã®å‰Šé™¤</div>
            <div class="custom-alert-body" id="deleteDialogMessage">
                æœ¬å½“ã«ã“ã®å¯¾å±€ã‚’å‰Šé™¤ã—ã¾ã™ã‹?
            </div>
            <div class="custom-alert-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="custom-alert-button" style="background: #999;" onclick="closeDeleteDialog()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="custom-alert-button" onclick="confirmDelete()">å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <!-- æ–°ã—ã„ç¯€ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div id="newSectionDialogOverlay" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <div class="custom-alert-header">æ–°ã—ã„ç¯€ã‚’ä½œæˆ</div>
            <div class="custom-alert-body">
                æ–°ã—ã„ç¯€ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ
            </div>
            <div class="custom-alert-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="custom-alert-button" style="background: #999;" onclick="closeNewSectionDialog()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="custom-alert-button" onclick="confirmNewSection()">ä½œæˆ</button>
            </div>
        </div>
    </div>



    <!-- ä¿å­˜ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div id="saveConfirmDialogOverlay" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <div class="custom-alert-header">ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜</div>
            <div class="custom-alert-body">
                ã—ã‚‡ãƒ¼ã¾ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾æˆ¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ
            </div>
            <div class="custom-alert-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="custom-alert-button" style="background: #999;" onclick="closeSaveConfirmDialog()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="custom-alert-button" onclick="confirmSaveSnapshot()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- APIè¨­å®š ---
        let API_TOKEN = null;
        const API_URL = "https://mahjong-scoresheet-api.oshomadesse.workers.dev/mahjong";

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        const players = ['ğŸ›¡ï¸ã‚¸ã‚§ãƒƒãƒ„è¥¿æ–¹ğŸ›¡ï¸', 'ğŸºãƒ“ãƒ¼ã‚¹ãƒˆé«˜æ©‹ğŸº', 'ğŸ²ãƒ•ã‚¡ã‚¤ãƒˆå¤§ç”°ğŸ²'];
        const shortNames = players.map(p => {
            const chars = Array.from(p);  // çµµæ–‡å­—ã‚’æ­£ã—ãæ‰±ã†ãŸã‚ã«é…åˆ—åŒ–
            const emojiStart = chars[0];   // æœ€åˆã®æ–‡å­—ï¼ˆçµµæ–‡å­—ï¼‰
            const emojiEnd = chars[chars.length - 1];   // æœ€å¾Œã®æ–‡å­—ï¼ˆçµµæ–‡å­—ï¼‰
            const name = p.replace(/.*(è¥¿æ–¹|é«˜æ©‹|å¤§ç”°).*/, "$1"); // åå­—æŠ½å‡º
            return `${emojiStart}${name}${emojiEnd}`;
        });
        
        let sections = []; // ç¯€ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ [{games: [...]}]
        let currentSectionIndex = 0; // ç¾åœ¨è¡¨ç¤ºä¸­ã®ç¯€ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        let rankingMode = 'today'; // 'today' or 'total'
        
        // ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        function showDialog(message, title = 'ã‚¨ãƒ©ãƒ¼', headerColor = '#c41e3a') {
            const overlay = document.getElementById('customAlertOverlay');
            const titleElement = document.getElementById('customAlertTitle');
            const messageElement = document.getElementById('customAlertMessage');
            titleElement.textContent = title;
            titleElement.style.background = headerColor;
            messageElement.textContent = message;
            overlay.style.display = 'flex';
        }
        
        // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚
        function showError(message) {
            showDialog(message, 'ã‚¨ãƒ©ãƒ¼', '#c41e3a');
        }
        
        function closeCustomAlert() {
            const overlay = document.getElementById('customAlertOverlay');
            overlay.style.display = 'none';
        }
        
        // ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç”¨ã®å¤‰æ•°
        let editingSectionIndex = null;
        let editingGameIndex = null;
        
        // ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        function showEditDialog(sectionIndex, gameIndex) {
            editingSectionIndex = sectionIndex;
            editingGameIndex = gameIndex;
            
            const game = sections[sectionIndex].games[gameIndex];
            
            document.getElementById('editScore1').value = game.scores[0];
            document.getElementById('editScore2').value = game.scores[1];
            document.getElementById('editScore3').value = game.scores[2];
            document.getElementById('editPoint1').value = game.points[0];
            document.getElementById('editPoint2').value = game.points[1];
            document.getElementById('editPoint3').value = game.points[2];
            
            document.getElementById('editDialogOverlay').style.display = 'flex';
        }
        
        // ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        function closeEditDialog() {
            document.getElementById('editDialogOverlay').style.display = 'none';
            
            // ç‚¹æ•°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç„¡åŠ¹åŒ–ã‚’è§£é™¤
            document.getElementById('editScore1').disabled = false;
            document.getElementById('editScore2').disabled = false;
            document.getElementById('editScore3').disabled = false;
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å…ƒã«æˆ»ã™
            document.querySelector('#editDialogOverlay .custom-alert-header').textContent = 'å¯¾å±€çµæœã‚’ç·¨é›†';
            
            editingSectionIndex = null;
            editingGameIndex = null;
        }
        
        // ç·¨é›†ã‚’ä¿å­˜
        function saveEditedGame() {
            const newPoints = [
                parseFloat(document.getElementById('editPoint1').value),
                parseFloat(document.getElementById('editPoint2').value),
                parseFloat(document.getElementById('editPoint3').value)
            ];
            
            if (newPoints.some(p => isNaN(p))) {
                showError('ã™ã¹ã¦ã®å€¤ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const pointSum = newPoints[0] + newPoints[1] + newPoints[2];
            if (Math.abs(pointSum) > 0.1) {
                showError(`3äººã®ãƒã‚¤ãƒ³ãƒˆã®åˆè¨ˆãŒ 0 ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆç¾åœ¨: ${pointSum.toFixed(1)}ï¼‰`);
                return;
            }
            
            // ç¯€ã®åˆè¨ˆç·¨é›†ã®å ´åˆ
            if (editingGameIndex === null) {
                // ç¾åœ¨ã®åˆè¨ˆã‚’è¨ˆç®—
                const section = sections[editingSectionIndex];
                const currentTotal = [0, 0, 0];
                section.games.forEach(game => {
                    game.points.forEach((p, i) => currentTotal[i] += p);
                });
                
                // å·®åˆ†ã‚’è¨ˆç®—
                const diff = [
                    newPoints[0] - currentTotal[0],
                    newPoints[1] - currentTotal[1],
                    newPoints[2] - currentTotal[2]
                ];
                
                // æœ€å¾Œã®å¯¾å±€ã«å·®åˆ†ã‚’é©ç”¨
                if (section.games.length > 0) {
                    const lastGame = section.games[section.games.length - 1];
                    lastGame.points[0] += diff[0];
                    lastGame.points[1] += diff[1];
                    lastGame.points[2] += diff[2];
                }
            } else {
                // å€‹åˆ¥ã®å¯¾å±€ç·¨é›†ã®å ´åˆ
                const newScores = [
                    parseInt(document.getElementById('editScore1').value),
                    parseInt(document.getElementById('editScore2').value),
                    parseInt(document.getElementById('editScore3').value)
                ];
                
                if (newScores.some(s => isNaN(s))) {
                    showError('ã™ã¹ã¦ã®å€¤ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                const scoreSum = newScores[0] + newScores[1] + newScores[2];
                if (scoreSum !== 105000) {
                    showError(`3äººã®ç‚¹æ•°ã®åˆè¨ˆãŒ 105000 ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆç¾åœ¨: ${scoreSum}ï¼‰`);
                    return;
                }
                
                const game = sections[editingSectionIndex].games[editingGameIndex];
                game.scores = newScores;
                game.points = newPoints;
            }
            
            saveData();
            updateHistory();
            updateRanking();
            closeEditDialog();
        }
        
        // å‰Šé™¤ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç”¨ã®å¤‰æ•°
        let deletingSectionIndex = null;
        let deletingGameIndex = null;
        
        // å‰Šé™¤ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        function showDeleteDialog(sectionIndex, gameIndex) {
            deletingSectionIndex = sectionIndex;
            deletingGameIndex = gameIndex;
            
            // å€‹åˆ¥ã®åŠè˜å‰Šé™¤ã®å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
            if (gameIndex !== null) {
                document.getElementById('deleteDialogMessage').textContent = 'ã“ã®åŠè˜ã‚’å‰Šé™¤ã—ã¦è‰¯ã„ã§ã™ã‹ï¼Ÿ';
            }
            
            document.getElementById('deleteDialogOverlay').style.display = 'flex';
        }
        
        // å‰Šé™¤ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        function closeDeleteDialog() {
            document.getElementById('deleteDialogOverlay').style.display = 'none';
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
            document.getElementById('deleteDialogMessage').textContent = 'æœ¬å½“ã«ã“ã®å¯¾å±€ã‚’å‰Šé™¤ã—ã¾ã™ã‹?';
            deletingSectionIndex = null;
            deletingGameIndex = null;
        }
        
        // å‰Šé™¤ã‚’ç¢ºå®š
        function confirmDelete() {
            if (deletingSectionIndex !== null) {
                if (deletingGameIndex !== null) {
                    // å€‹åˆ¥ã®å¯¾å±€ã‚’å‰Šé™¤
                    sections[deletingSectionIndex].games.splice(deletingGameIndex, 1);
                    
                    if (sections[deletingSectionIndex].games.length === 0 && sections.length > 1) {
                        sections.splice(deletingSectionIndex, 1);
                        if (currentSectionIndex >= sections.length) {
                            currentSectionIndex = sections.length - 1;
                        }
                    }
                } else {
                    // ç¯€å…¨ä½“ã‚’å‰Šé™¤ï¼ˆæœ€å¾Œã®1ç¯€ã§ã‚‚è¨±å¯ï¼‰
                    sections.splice(deletingSectionIndex, 1);
                    
                    if (sections.length === 0) {
                        } else if (currentSectionIndex >= sections.length) {
                        currentSectionIndex = sections.length - 1;
                    }
                }
                
                saveData();
                updateRanking();
                updateHistory();
                closeDeleteDialog();
            }
        }
        
        // ç¯€ã®åˆè¨ˆã‚’ç·¨é›†
        function editSectionTotal(sectionIndex) {
            const section = sections[sectionIndex];
            
            // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆè¨ˆãƒã‚¤ãƒ³ãƒˆã‚’è¨ˆç®—
            const totalPoints = [0, 0, 0];
            section.games.forEach(game => {
                game.points.forEach((p, i) => totalPoints[i] += p);
            });
            
            editingSectionIndex = sectionIndex;
            editingGameIndex = null; // ç¯€å…¨ä½“ã®ç·¨é›†ãªã®ã§null
            
            // ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã«åˆè¨ˆå€¤ã‚’è¨­å®šï¼ˆç‚¹æ•°ã¯0ã§å›ºå®šï¼‰
            document.getElementById('editScore1').value = 0;
            document.getElementById('editScore2').value = 0;
            document.getElementById('editScore3').value = 0;
            document.getElementById('editPoint1').value = totalPoints[0];
            document.getElementById('editPoint2').value = totalPoints[1];
            document.getElementById('editPoint3').value = totalPoints[2];
            
            // ç‚¹æ•°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
            document.getElementById('editScore1').disabled = true;
            document.getElementById('editScore2').disabled = true;
            document.getElementById('editScore3').disabled = true;
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å¤‰æ›´
            document.querySelector('#editDialogOverlay .custom-alert-header').textContent = 'ç¬¬' + (sectionIndex + 1) + 'ç¯€ã®åˆè¨ˆã‚’ç·¨é›†';
            
            document.getElementById('editDialogOverlay').style.display = 'flex';
        }
        
        // ç¯€å…¨ä½“ã‚’å‰Šé™¤
        function deleteSection(sectionIndex) {
            deletingSectionIndex = sectionIndex;
            deletingGameIndex = null;
            
            const section = sections[sectionIndex];
            const gameCount = section.games.length;
            
            document.getElementById('deleteDialogMessage').textContent = 
                `ç¬¬${sectionIndex + 1}ç¯€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆ${gameCount}åŠè˜ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`;
            document.getElementById('deleteDialogOverlay').style.display = 'flex';
        }


        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãƒã‚§ãƒƒã‚¯
        // èªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¯¿å‘½ï¼ˆ2æ™‚é–“ï¼‰
        const AUTH_DURATION = 2 * 60 * 60 * 1000;

        function checkAuth() {
            const authData = sessionStorage.getItem('mahjong-auth');
                if (!authData) return false;
            
                try {
                    const { timestamp } = JSON.parse(authData);
                    const now = Date.now();
                    if (now - timestamp < AUTH_DURATION) {
                        updateAuthTimestamp();
                        return true;
                    }
                } catch (e) {
                    console.error('Auth check error:', e);
                }

                return false;
            }

            function saveAuth(token) {
                sessionStorage.setItem('mahjong-auth', JSON.stringify({
                    timestamp: Date.now(),
                    token: token
                }));
            }

            function updateAuthTimestamp() {
                const authData = sessionStorage.getItem('mahjong-auth');
                if (authData) {
                    const parsed = JSON.parse(authData);
                    sessionStorage.setItem('mahjong-auth', JSON.stringify({
                        timestamp: Date.now(),
                        token: parsed.token
                    }));
                }
            }

            function getStoredToken() {
                const authData = sessionStorage.getItem('mahjong-auth');
                if (authData) {
                    try {
                        const { token } = JSON.parse(authData);
                        return token || null;
                    } catch (e) {
                        return null;
                    }
                }
                return null;
            }

        
            async function checkPassword() {
                const input = document.getElementById('passwordInput');
                const error = document.getElementById('passwordError');
                const pass = input.value;

                try {
                    console.log('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚’é–‹å§‹ã—ã¾ã™...');
                    console.log('API URL:', API_URL);
                    
                    // Worker ã«æŠ•ã’ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
                    const res = await fetch(API_URL, {
                        method: "GET",
                        headers: { "x-access-token": pass }
                    });

                    console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', res.status);

                    if (res.status === 200) {
                        console.log('èªè¨¼æˆåŠŸï¼');

                        // èªè¨¼æˆåŠŸ â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã‚‚å«ã‚€ï¼‰
                        API_TOKEN = pass;
                        saveAuth(pass);

                        // UI åˆ‡ã‚Šæ›¿ãˆ
                        document.getElementById('passwordOverlay').style.display = 'none';
                        document.getElementById('mainContainer').style.display = 'block';
                        error.textContent = '';

                        // åˆå›ãƒ­ãƒ¼ãƒ‰
                        const data = await res.json();
                        console.log('ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data);
                        sections = data?.sections || [];

                        // åˆå›åˆ©ç”¨ã®å ´åˆã¯ç©ºãªã‚‰ç¬¬1ç¯€ã‚’ä½œã‚‹
                        if (sections.length === 0) {
                            sections.push({ games: [] });
                        }

                        // æœ€æ–°ã®ç¯€ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º
                        currentSectionIndex = sections.length - 1;

                        updateRanking();
                        updateHistory();

                    } else {
                        // èªè¨¼å¤±æ•—
                        console.log('èªè¨¼å¤±æ•—: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰', res.status);
                        const responseText = await res.text();
                        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹:', responseText);
                        error.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ (Status: ' + res.status + ')';
                        input.value = '';
                        input.focus();
                    }
                } catch (err) {
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
                    console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', err);
                    error.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message;
                    input.focus();
                }
            }

        
        // Enterã‚­ãƒ¼ã§ã‚‚ãƒ­ã‚°ã‚¤ãƒ³
        window.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPassword();
                    }
                });
            }
            
            // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®èªè¨¼ãƒã‚§ãƒƒã‚¯
            if (checkAuth()) {
                // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¾©å…ƒ
                const storedToken = getStoredToken();
                if (storedToken) {
                    API_TOKEN = storedToken;
                    const overlay = document.getElementById('passwordOverlay');
                    const container = document.getElementById('mainContainer');
                    if (overlay) overlay.style.display = 'none';
                    if (container) container.style.display = 'block';
                    // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
                    loadData();
                } else {
                    // ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã¯å†èªè¨¼
                    sessionStorage.removeItem('mahjong-auth');
                    const passwordInput = document.getElementById('passwordInput');
                    if (passwordInput) passwordInput.focus();
                }
            } else {
                const passwordInput = document.getElementById('passwordInput');
                if (passwordInput) passwordInput.focus();
            }
            setupAutoCalculation();
        });
        
        // ç‚¹æ•°ã®è‡ªå‹•å…¥åŠ›æ©Ÿèƒ½
        function setupAutoCalculation() {
        // ã¾ãšå…¥åŠ›å€¤ã‚’å–å¾—
        const score1Input = document.getElementById('score1');
        const score2Input = document.getElementById('score2');
        const score3Input = document.getElementById('score3');
        
        // 2ã¤ã®ç‚¹æ•°ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¦ã€3ã¤ç›®ãŒç©ºã®å ´åˆã¯è‡ªå‹•è¨ˆç®—
        const s1 = parseInt(score1Input.value) || 0;
        const s2 = parseInt(score2Input.value) || 0;
        const s3 = parseInt(score3Input.value) || 0;
        
        if (score1Input.value && score2Input.value && !score3Input.value) {
            score3Input.value = 105000 - s1 - s2;
        }
        else if (score1Input.value && score3Input.value && !score2Input.value) {
            score2Input.value = 105000 - s1 - s3;
        }
        else if (score2Input.value && score3Input.value && !score1Input.value) {
            score1Input.value = 105000 - s2 - s3;
        }
        
        // è¨ˆç®—å¾Œã®å€¤ã‚’å–å¾—
        const score1 = parseInt(score1Input.value);
        const score2 = parseInt(score2Input.value);
        const score3 = parseInt(score3Input.value);
            
            if (!score1 || !score2 || !score3) return;
            
            function autoFillScore() {
                const s1 = parseInt(score1.value) || 0;
                const s2 = parseInt(score2.value) || 0;
                const s3 = parseInt(score3.value) || 0;
                
                // score1ã¨score2ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¦ã€score3ãŒç©ºã®å ´åˆ
                if (score1.value && score2.value && !score3.value) {
                    score3.value = 105000 - s1 - s2;
                }
                // score1ã¨score3ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¦ã€score2ãŒç©ºã®å ´åˆ
                else if (score1.value && score3.value && !score2.value) {
                    score2.value = 105000 - s1 - s3;
                }
                // score2ã¨score3ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¦ã€score1ãŒç©ºã®å ´åˆ
                else if (score2.value && score3.value && !score1.value) {
                    score1.value = 105000 - s2 - s3;
                }
            }
        }
    </script>

    <div class="container" id="mainContainer" style="display: none;">
        <h1>ğŸ€„ éº»é›€ã‚¹ã‚³ã‚¢ã‚·ãƒ¼ãƒˆ ğŸ€„</h1>
        <h2 style="text-align:center; color:#2d5016; margin-bottom:15px; font-size:18px;">ã€œ Tãƒªãƒ¼ã‚°å°‚ç”¨ ã€œ</h2>

        <!-- é †ä½è¡¨ -->
        <div class="section">
            <h3 class="section-title">ğŸ“Š é †ä½è¡¨</h3>
            <div class="ranking-tabs">
                <div class="ranking-tab active" onclick="switchRankingTab('today')">æœ¬æ—¥</div>
                <div class="ranking-tab" onclick="switchRankingTab('total')">å…¨ä½“</div>
            </div>
            <div id="rankingList"></div>
        </div>

        <!-- å¯¾å±€å…¥åŠ› -->
        <div class="section" id="gameInputSection">
            <h3 class="section-title">
                <span>âœï¸ å¯¾å±€çµæœå…¥åŠ›</span>
                <button class="ios-button" onclick="clearInputs()">ã‚¯ãƒªã‚¢</button>
            </h3>
            <div class="input-grid">
                <div class="input-item">
                    <label>ğŸ›¡ï¸ã‚¸ã‚§ãƒƒãƒ„è¥¿æ–¹ğŸ›¡ï¸</label>
                    <input type="number" id="score1" placeholder="ç‚¹æ•°ã‚’å…¥åŠ›" step="100">
                    <div class="yakuman-check">
                        <div>
                            <input type="checkbox" id="tobi1">
                            <label for="tobi1">é£›ã³</label>
                        </div>
                        <div>
                            <input type="checkbox" id="tobashi1">
                            <label for="tobashi1">é£›ã°ã—</label>
                        </div>
                        <div>
                            <input type="checkbox" id="doubleTobashi1">
                            <label for="doubleTobashi1">ãƒ€ãƒ–ãƒ«é£›ã°ã—</label>
                        </div>
                    </div>
                    <div class="yakuman-check">
                        <div>
                            <input type="checkbox" id="yakuman1">
                            <label for="yakuman1">å½¹æº€</label>
                        </div>
                        <div>
                            <input type="checkbox" id="doubleYakuman1">
                            <label for="doubleYakuman1">ãƒ€ãƒ–ãƒ«å½¹æº€</label>
                        </div>
                        <div>
                            <input type="checkbox" id="tripleYakuman1">
                            <label for="tripleYakuman1">ãƒˆãƒªãƒ—ãƒ«å½¹æº€</label>
                        </div>
                    </div>
                </div>
                <div class="input-item">
                    <label>ğŸºãƒ“ãƒ¼ã‚¹ãƒˆé«˜æ©‹ğŸº</label>
                    <input type="number" id="score2" placeholder="ç‚¹æ•°ã‚’å…¥åŠ›" step="100">
                    <div class="yakuman-check">
                        <div>
                            <input type="checkbox" id="tobi2">
                            <label for="tobi2">é£›ã³</label>
                        </div>
                        <div>
                            <input type="checkbox" id="tobashi2">
                            <label for="tobashi2">é£›ã°ã—</label>
                        </div>
                        <div>
                            <input type="checkbox" id="doubleTobashi2">
                            <label for="doubleTobashi2">ãƒ€ãƒ–ãƒ«é£›ã°ã—</label>
                        </div>
                    </div>
                    <div class="yakuman-check">
                        <div>
                            <input type="checkbox" id="yakuman2">
                            <label for="yakuman2">å½¹æº€</label>
                        </div>
                        <div>
                            <input type="checkbox" id="doubleYakuman2">
                            <label for="doubleYakuman2">ãƒ€ãƒ–ãƒ«å½¹æº€</label>
                        </div>
                        <div>
                            <input type="checkbox" id="tripleYakuman2">
                            <label for="tripleYakuman2">ãƒˆãƒªãƒ—ãƒ«å½¹æº€</label>
                        </div>
                    </div>
                </div>
                <div class="input-item">
                    <label>ğŸ²ãƒ•ã‚¡ã‚¤ãƒˆå¤§ç”°ğŸ²</label>
                    <input type="number" id="score3" placeholder="ç‚¹æ•°ã‚’å…¥åŠ›" step="100">
                    <div class="yakuman-check">
                        <div>
                            <input type="checkbox" id="tobi3">
                            <label for="tobi3">é£›ã³</label>
                        </div>
                        <div>
                            <input type="checkbox" id="tobashi3">
                            <label for="tobashi3">é£›ã°ã—</label>
                        </div>
                        <div>
                            <input type="checkbox" id="doubleTobashi3">
                            <label for="doubleTobashi3">ãƒ€ãƒ–ãƒ«é£›ã°ã—</label>
                        </div>
                    </div>
                    <div class="yakuman-check">
                        <div>
                            <input type="checkbox" id="yakuman3">
                            <label for="yakuman3">å½¹æº€</label>
                        </div>
                        <div>
                            <input type="checkbox" id="doubleYakuman3">
                            <label for="doubleYakuman3">ãƒ€ãƒ–ãƒ«å½¹æº€</label>
                        </div>
                        <div>
                            <input type="checkbox" id="tripleYakuman3">
                            <label for="tripleYakuman3">ãƒˆãƒªãƒ—ãƒ«å½¹æº€</label>
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn" onclick="addGame()">å¯¾å±€ã‚’è¨˜éŒ²</button>
        </div>

        <!-- å¯¾å±€å±¥æ­´ -->
        <div class="section" id="historySection">
            <h3 class="section-title">
                <span>ğŸ“œ å¯¾å±€å±¥æ­´</span>
                <button class="ios-button" onclick="refreshData()">æ›´æ–°</button>
            </h3>
            <div class="tabs-container" id="tabsContainer"></div>
            <div class="history-table-container">
                <table class="history-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>åŠè˜</th>
                            <th>ğŸ›¡ï¸è¥¿æ–¹</th>
                            <th>ğŸºé«˜æ©‹</th>
                            <th>ğŸ²å¤§ç”°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="historyList">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ãƒã‚¤ãƒ³ãƒˆæ¨ç§»ã‚°ãƒ©ãƒ• -->
        <div class="section">
            <h3 class="section-title">
                <span>ğŸ“ˆ åˆè¨ˆãƒã‚¤ãƒ³ãƒˆæ¨ç§»</span>
            </h3>
            <div style="background: white; border-radius: 8px; padding: 10px; border: 2px solid #2d5016;">
                <canvas id="pointTrendChart"></canvas>
            </div>
        </div>

        <!-- æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆ -->
        <div class="section" id="finalPointsSection">
            <h3 class="section-title">
                <span>ğŸ’¯ æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—</span>
                <button class="ios-button" onclick="saveSnapshot()">ä¿å­˜</button>
            </h3>
            
            <div class="input-grid">
                <div class="input-item">
                    <label>ã‚²ãƒ¼ãƒ ä»£</label>
                    <input type="number" id="tableFee" placeholder="">
                </div>

            <div class="input-item">
                <label>æ”¯æ‰•ã„è€…</label>
                <select id="payer" 
                    style="padding:15px; font-size:18px; border:2px solid #2d5016; border-radius:12px; width:100%;">
                    <option value="1">ğŸºãƒ“ãƒ¼ã‚¹ãƒˆé«˜æ©‹ğŸº</option>
                    <option value="0">ğŸ›¡ï¸ã‚¸ã‚§ãƒƒãƒ„è¥¿æ–¹ğŸ›¡ï¸</option>
                    <option value="2">ğŸ²ãƒ•ã‚¡ã‚¤ãƒˆå¤§ç”°ğŸ²</option>
                </select>
            </div>
        <button class="btn" onclick="calcFinalPoints()">ãƒã‚§ãƒƒã‚¯</button>
        <div id="finalPointsResult" style="margin-top:15px;"></div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«å¿…ãšãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã•ã›ã‚‹
        function requestPassword() {
            API_TOKEN = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
        }

        // -------------------------
        // Cloudflare Worker ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        // -------------------------
        async function loadData() {

            // â‘  èªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç¢ºèªï¼ˆ2æ™‚é–“ä»¥å†…ãªã‚‰OKï¼‰
            if (!checkAuth()) {
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœªå…¥åŠ› or æœ‰åŠ¹æœŸé™åˆ‡ã‚Œ â†’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”»é¢ã‚’è¡¨ç¤º
                document.getElementById('passwordOverlay').style.display = 'flex';
                document.getElementById('mainContainer').style.display = 'none';
                return;
            }
        
            // â‘¡ Worker ã¸ GET ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const res = await fetch(API_URL, {
                method: "GET",
                headers: {
                    "x-access-token": API_TOKEN
                }
            });
        
            if (res.status !== 200) {
                console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼", res.status);
                alert("ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                return;
            }
        
            const data = await res.json();
            sections = data?.sections || [];
        
            // â‘¢ åˆå›åˆ©ç”¨ã®å ´åˆã¯ç©ºãªã‚‰ç¬¬1ç¯€ã‚’ä½œã‚‹
            if (sections.length === 0) {
                sections.push({ games: [] });
            }
        
            currentSectionIndex = sections.length - 1;
        
            updateRanking();
            updateHistory();
        }
        
        // -------------------------
        // Cloudflare Worker ã¸ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        // -------------------------
        async function saveData() {
            const res = await fetch(API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-access-token": API_TOKEN
                },
                body: JSON.stringify({ sections })
            });
        
            if (res.status !== 200) {
                console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼", res.status);
                alert("ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }


        // ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—é–¢æ•°
        function calculatePoints(scores, yakumanFlags, tobashiFlags, tobiFlags, doubleYakumanFlags, doubleTobashiFlags, tripleYakumanFlags) {
            // 40000ã‚’å¼•ã„ã¦1000ã§å‰²ã‚‹
            const basePoints = scores.map(score => (score - 40000) / 1000);
            
            // ãƒã‚¤ãƒ³ãƒˆã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒšã‚¢ã«ã—ã¦ä¿å­˜
            const pointsWithIndex = basePoints.map((point, index) => ({ point, index, score: scores[index] }));
            
            // ãƒã‚¤ãƒ³ãƒˆã§é™é †ã‚½ãƒ¼ãƒˆï¼ˆé«˜ã„é †ï¼‰
            pointsWithIndex.sort((a, b) => b.point - a.point);
            
            const finalPoints = [0, 0, 0];
            
            const firstPoint = pointsWithIndex[0].point;
            const secondPoint = pointsWithIndex[1].point;
            const thirdPoint = pointsWithIndex[2].point;
            
            const firstIndex = pointsWithIndex[0].index;
            const secondIndex = pointsWithIndex[1].index;
            const thirdIndex = pointsWithIndex[2].index;
            
            // 2ä½ã¨3ä½ãŒåŒç‚¹ã®å ´åˆ
            if (secondPoint === thirdPoint) {
                // 3ä½ã®ãƒšãƒŠãƒ«ãƒ†ã‚£-10ã‚’2äººã§åˆ†å‰² â†’ -5ãšã¤
                finalPoints[secondIndex] = secondPoint - 5;
                finalPoints[thirdIndex] = thirdPoint - 5;
                
                // 1ä½ã¯2ä½ã¨3ä½ã®åˆè¨ˆã®é€†æ•°
                finalPoints[firstIndex] = -(finalPoints[secondIndex] + finalPoints[thirdIndex]);
                
            } else {
                // é€šå¸¸ã®å‡¦ç†
                finalPoints[firstIndex] = firstPoint;
                finalPoints[secondIndex] = secondPoint;
                finalPoints[thirdIndex] = thirdPoint - 10; // 3ç€ã¯-10
                
                // 1ä½ã¯2ä½ã¨3ä½ã®åˆè¨ˆã®é€†æ•°ï¼ˆ0ã«ãªã‚‹ã‚ˆã†ã«ï¼‰
                finalPoints[firstIndex] = -(finalPoints[secondIndex] + finalPoints[thirdIndex]);
            }
            
            // é£›ã³ã®å‡¦ç†
            const tobiCount = tobiFlags.filter(x => x).length;
            tobiFlags.forEach((isTobi, index) => {
                if (isTobi) {
                    // é£›ã°ã•ã‚ŒãŸäººã¯-10
                    finalPoints[index] -= 10;
                }
            });
            
            // é£›ã°ã—ãƒ»ãƒ€ãƒ–ãƒ«é£›ã°ã—ã®å‡¦ç†
            const tobashiCount = tobashiFlags.filter(x => x).length;
            const doubleTobashiCount = doubleTobashiFlags.filter(x => x).length;
            
            // ç‰¹æ®Šã‚±ãƒ¼ã‚¹: é£›ã°ã—2ã¤ã€é£›ã³1ã¤ã®å ´åˆ
            const isSpecialCase = (tobashiCount === 2 && doubleTobashiCount === 0 && tobiCount === 1);
            
            if (isSpecialCase) {
                // é£›ã°ã—ã®2äººã«+5ptãšã¤
                tobashiFlags.forEach((isTobashi, index) => {
                    if (isTobashi) {
                        finalPoints[index] += 5;
                    }
                });
            } else {
                // é€šå¸¸ã®é£›ã°ã—ã®ãƒœãƒ¼ãƒŠã‚¹é…åˆ†
                if (tobashiCount > 0) {
                    tobashiFlags.forEach((isTobashi, index) => {
                        if (isTobashi) {
                            // é£›ã°ã—1äººã«ã¤ã +10ãƒã‚¤ãƒ³ãƒˆ
                            finalPoints[index] += 10;
                        }
                    });
                }
            }
            
            // ãƒ€ãƒ–ãƒ«é£›ã°ã—ã®ãƒœãƒ¼ãƒŠã‚¹é…åˆ†
            if (doubleTobashiCount > 0) {
                doubleTobashiFlags.forEach((isDoubleTobashi, index) => {
                    if (isDoubleTobashi) {
                        // ãƒ€ãƒ–ãƒ«é£›ã°ã—1äººã«ã¤ã +20ãƒã‚¤ãƒ³ãƒˆ
                        finalPoints[index] += 20;
                    }
                });
            }
            
            // å½¹æº€ã®å‡¦ç†
            yakumanFlags.forEach((hasYakuman, index) => {
                if (hasYakuman) {
                    // å½¹æº€ã‚’ä¸ŠãŒã£ãŸäººã«+40
                    finalPoints[index] += 40;
                    // æ®‹ã‚Šã®äºŒäººã‹ã‚‰-20ãšã¤
                    for (let i = 0; i < 3; i++) {
                        if (i !== index) {
                            finalPoints[i] -= 20;
                        }
                    }
                }
            });

            // ãƒ€ãƒ–ãƒ«å½¹æº€ã®å‡¦ç†ï¼ˆå½¹æº€ã®2å€ï¼‰
            doubleYakumanFlags.forEach((hasDouble, index) => {
                if (hasDouble) {
                    // ã‚¢ã‚¬ã£ãŸäººã« +80
                    finalPoints[index] += 80;
                // ä»–2äººã« âˆ’40ãšã¤
                for (let i = 0; i < 3; i++) {
                        if (i !== index) {
                            finalPoints[i] -= 40;
                        }
                    }
                }
            });

            // ãƒˆãƒªãƒ—ãƒ«å½¹æº€ã®å‡¦ç†ï¼ˆå½¹æº€ã®3å€ï¼‰
            if (tripleYakumanFlags) {
                tripleYakumanFlags.forEach((hasTriple, index) => {
                    if (hasTriple) {
                        // ã‚¢ã‚¬ã£ãŸäººã« +120
                        finalPoints[index] += 120;
                        // ä»–2äººã« âˆ’60ãšã¤
                        for (let i = 0; i < 3; i++) {
                            if (i !== index) {
                                finalPoints[i] -= 60;
                            }
                        }
                    }
                });
            }

            return finalPoints;
        }

        // å¯¾å±€ã‚’è¿½åŠ 
        function addGame() {
            // ã¾ãšå…¥åŠ›å€¤ã‚’å–å¾—
            const score1Input = document.getElementById('score1');
            const score2Input = document.getElementById('score2');
            const score3Input = document.getElementById('score3');
            
            // å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ç‚¹æ•°ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            let inputCount = 0;
            if (score1Input.value) inputCount++;
            if (score2Input.value) inputCount++;
            if (score3Input.value) inputCount++;
            
            // 1äººã—ã‹å…¥åŠ›ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
            if (inputCount < 2) {
                showError('ã™ã¹ã¦ã®ç‚¹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // 2ã¤ã®ç‚¹æ•°ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¦ã€3ã¤ç›®ãŒç©ºã®å ´åˆã¯è‡ªå‹•è¨ˆç®—
            const s1 = parseInt(score1Input.value) || 0;
            const s2 = parseInt(score2Input.value) || 0;
            const s3 = parseInt(score3Input.value) || 0;
            
            if (score1Input.value && score2Input.value && !score3Input.value) {
                score3Input.value = 105000 - s1 - s2;
            }
            else if (score1Input.value && score3Input.value && !score2Input.value) {
                score2Input.value = 105000 - s1 - s3;
            }
            else if (score2Input.value && score3Input.value && !score1Input.value) {
                score1Input.value = 105000 - s2 - s3;
            }
            
            // è¨ˆç®—å¾Œã®å€¤ã‚’å–å¾—
            const score1 = parseInt(score1Input.value);
            const score2 = parseInt(score2Input.value);
            const score3 = parseInt(score3Input.value);
            
            // åˆè¨ˆ105000ãƒã‚§ãƒƒã‚¯
            const sum = score1 + score2 + score3;
            if (sum !== 105000) {
                showError(`3äººã®ç‚¹æ•°ã®åˆè¨ˆãŒ 105000 ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆç¾åœ¨: ${sum}ï¼‰`);
                return;
            }


            const scores = [score1, score2, score3];
            const yakumanFlags = [
                document.getElementById('yakuman1').checked,
                document.getElementById('yakuman2').checked,
                document.getElementById('yakuman3').checked
            ];
            const doubleYakumanFlags = [
                document.getElementById('doubleYakuman1').checked,
                document.getElementById('doubleYakuman2').checked,
                document.getElementById('doubleYakuman3').checked
            ];
            const tobashiFlags = [
                document.getElementById('tobashi1').checked,
                document.getElementById('tobashi2').checked,
                document.getElementById('tobashi3').checked
            ];
            const tobiFlags = [
                document.getElementById('tobi1').checked,
                document.getElementById('tobi2').checked,
                document.getElementById('tobi3').checked
            ];
            const doubleTobashiFlags = [
                document.getElementById('doubleTobashi1').checked,
                document.getElementById('doubleTobashi2').checked,
                document.getElementById('doubleTobashi3').checked
            ];
            const tripleYakumanFlags = [
                document.getElementById('tripleYakuman1').checked,
                document.getElementById('tripleYakuman2').checked,
                document.getElementById('tripleYakuman3').checked
            ];

            // é£›ã°ã—ãƒ»ãƒ€ãƒ–ãƒ«é£›ã°ã—ã¨é£›ã³ã®å¯¾å¿œãƒã‚§ãƒƒã‚¯
            const tobashiCount = tobashiFlags.filter(x => x).length;
            const doubleTobashiCount = doubleTobashiFlags.filter(x => x).length;
            const tobiCount = tobiFlags.filter(x => x).length;
            
            console.log('é£›ã°ã—:', tobashiCount, 'ãƒ€ãƒ–ãƒ«é£›ã°ã—:', doubleTobashiCount, 'é£›ã³:', tobiCount);
            
            // é€šå¸¸ã®é£›ã°ã—1ã¤ = é£›ã³1ã¤ã€ãƒ€ãƒ–ãƒ«é£›ã°ã—1ã¤ = é£›ã³2ã¤
            const totalTobashiEquivalent = tobashiCount + (doubleTobashiCount * 2);
            
            // ç‰¹æ®Šã‚±ãƒ¼ã‚¹: é£›ã°ã—2ã¤ã€é£›ã³1ã¤ã¯è¨±å¯
            const isSpecialCase = (tobashiCount === 2 && doubleTobashiCount === 0 && tobiCount === 1);
            
            if (!isSpecialCase && totalTobashiEquivalent !== tobiCount) {
                showError('ã€Œé£›ã°ã—ã€ã€Œãƒ€ãƒ–ãƒ«é£›ã°ã—ã€ã¨ã€Œé£›ã³ã€ã®äººæ•°ãŒå¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const points = calculatePoints(scores, yakumanFlags, tobashiFlags, tobiFlags, doubleYakumanFlags, doubleTobashiFlags, tripleYakumanFlags);

            const gameData = {
                scores: scores,
                points: points,
                yakumanFlags: yakumanFlags,
                doubleYakumanFlags: doubleYakumanFlags,
                tripleYakumanFlags: tripleYakumanFlags,
                tobashiFlags: tobashiFlags,
                tobiFlags: tobiFlags,
                doubleTobashiFlags: doubleTobashiFlags,
                timestamp: Date.now()
            };

            // æœ€æ–°ã®ç¯€ã«è¿½åŠ 
            if (sections.length === 0) {
                sections.push({ games: [] });
            }
            sections[sections.length - 1].games.push(gameData);
            
            saveData();
            
            // æœ€æ–°ã®ç¯€ã‚’è¡¨ç¤º
            currentSectionIndex = sections.length - 1;
            
            updateRanking();
            updateHistory();
            
            // å¯¾å±€å±¥æ­´ã®æœ€å¾Œã®è¡Œã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                const historyTable = document.getElementById('historyTable');
                const lastRow = historyTable?.querySelector('tbody tr:last-child');
                if (lastRow) {
                    lastRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);

            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            clearInputs();
        }

        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
        function clearInputs() {
            document.getElementById('score1').value = '';
            document.getElementById('score2').value = '';
            document.getElementById('score3').value = '';
            document.getElementById('yakuman1').checked = false;
            document.getElementById('yakuman2').checked = false;
            document.getElementById('yakuman3').checked = false;
            document.getElementById('doubleYakuman1').checked = false;
            document.getElementById('doubleYakuman2').checked = false;
            document.getElementById('doubleYakuman3').checked = false;
            document.getElementById('tripleYakuman1').checked = false;
            document.getElementById('tripleYakuman2').checked = false;
            document.getElementById('tripleYakuman3').checked = false;
            document.getElementById('tobashi1').checked = false;
            document.getElementById('tobashi2').checked = false;
            document.getElementById('tobashi3').checked = false;
            document.getElementById('doubleTobashi1').checked = false;
            document.getElementById('doubleTobashi2').checked = false;
            document.getElementById('doubleTobashi3').checked = false;
            document.getElementById('tobi1').checked = false;
            document.getElementById('tobi2').checked = false;
            document.getElementById('tobi3').checked = false;
        }

        // å¯¾å±€ã‚’å‰Šé™¤
        function deleteGame(sectionIndex, gameIndex) {
            showDeleteDialog(sectionIndex, gameIndex);
        }
        
        function editGame(sectionIndex, gameIndex) {
            showEditDialog(sectionIndex, gameIndex);
        }


        // æ–°ã—ã„ç¯€ã‚’è¿½åŠ 
        // æ–°ã—ã„ç¯€ã‚’è¿½åŠ ï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºï¼‰
        function addNewSection() {
            document.getElementById('newSectionDialogOverlay').style.display = 'flex';
        }
        
        // æ–°ã—ã„ç¯€ã®ä½œæˆã‚’ç¢ºå®š
        function confirmNewSection() {
            sections.push({ games: [] });
            currentSectionIndex = sections.length - 1;
            saveData();
            updateHistory();
            closeNewSectionDialog();
        }
        
        // æ–°ã—ã„ç¯€ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        function closeNewSectionDialog() {
            document.getElementById('newSectionDialogOverlay').style.display = 'none';
        }

        // é †ä½è¡¨ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
        function switchRankingTab(mode) {
            rankingMode = mode;

            // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            const tabs = document.querySelectorAll('.ranking-tab');
            tabs.forEach(tab => {
                if ((mode === 'today' && tab.textContent === 'æœ¬æ—¥') ||
                    (mode === 'total' && tab.textContent === 'å…¨ä½“')) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // å…¨ä½“ã‚¿ãƒ–æ™‚ã¯å¯¾å±€å…¥åŠ›ãƒ»å±¥æ­´ãƒ»æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆã‚’éè¡¨ç¤º
            const displayStyle = mode === 'total' ? 'none' : 'block';
            document.getElementById('gameInputSection').style.display = displayStyle;
            document.getElementById('historySection').style.display = displayStyle;
            document.getElementById('finalPointsSection').style.display = displayStyle;

            updateRanking();
            updatePointTrendChart();
        }

        // é †ä½è¡¨ã‚’æ›´æ–°
        function updateRanking() {
            const totalPoints = [0, 0, 0];
            
            if (rankingMode === 'today') {
                // æœ¬æ—¥ï¼šæœ€æ–°ã®ç¯€ã®ã¿
                if (sections.length > 0) {
                    const currentSection = sections[sections.length - 1];
                    currentSection.games.forEach(game => {
                        game.points.forEach((point, index) => {
                            totalPoints[index] += point;
                        });
                    });
                }
            } else {
                // å…¨ä½“ï¼šå…¨ã¦ã®ç¯€
                sections.forEach(section => {
                    section.games.forEach(game => {
                        game.points.forEach((point, index) => {
                            totalPoints[index] += point;
                        });
                    });
                });
            }

            // é †ä½ã‚’æ±ºå®š
            const ranking = totalPoints.map((points, index) => ({
                name: players[index],
                points: points,
                index: index
            }));

            ranking.sort((a, b) => b.points - a.points);

            // é †ä½è¡¨ã‚’è¡¨ç¤º
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';

            ranking.forEach((player, rank) => {
                const rankClass = rank === 0 ? 'first' : rank === 1 ? 'second' : 'third';
                const item = document.createElement('div');
                item.className = `ranking-item ${rankClass}`;
                item.innerHTML = `
                    <span class="rank-number">${rank + 1}ä½</span>
                    <span class="player-name">${player.name}</span>
                    <span class="player-points">${player.points > 0 ? '+' : ''}${player.points}</span>
                `;
                rankingList.appendChild(item);
            });
        }

        // ãƒã‚¤ãƒ³ãƒˆæ¨ç§»ã‚°ãƒ©ãƒ•
        let pointTrendChartInstance = null;

        function updatePointTrendChart() {
            const ctx = document.getElementById('pointTrendChart').getContext('2d');

            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Œã°ç ´æ£„
            if (pointTrendChartInstance) {
                pointTrendChartInstance.destroy();
            }

            let labels, nishikataData, takahashiData, otaData;

            if (rankingMode === 'total') {
                // å…¨ä½“ãƒ¢ãƒ¼ãƒ‰ï¼šç¯€ã”ã¨ã®ç´¯ç©ãƒã‚¤ãƒ³ãƒˆ
                labels = ['é–‹å§‹'];
                nishikataData = [0];
                takahashiData = [0];
                otaData = [0];

                let nTotal = 0, tTotal = 0, oTotal = 0;
                sections.forEach((section, sectionIndex) => {
                    // å„ç¯€ã®åˆè¨ˆãƒã‚¤ãƒ³ãƒˆã‚’è¨ˆç®—
                    let sectionN = 0, sectionT = 0, sectionO = 0;
                    section.games.forEach(game => {
                        sectionN += game.points[0];
                        sectionT += game.points[1];
                        sectionO += game.points[2];
                    });
                    nTotal += sectionN;
                    tTotal += sectionT;
                    oTotal += sectionO;

                    labels.push(`ç¯€${sectionIndex + 1}`);
                    nishikataData.push(nTotal);
                    takahashiData.push(tTotal);
                    otaData.push(oTotal);
                });

                // ãƒ‡ãƒ¼ã‚¿ãªã—ã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (sections.length === 0) {
                    labels = ['é–‹å§‹'];
                    nishikataData = [0];
                    takahashiData = [0];
                    otaData = [0];
                }
            } else {
                // æœ¬æ—¥ãƒ¢ãƒ¼ãƒ‰ï¼šç¾åœ¨ã®ç¯€ã®åŠè˜ã”ã¨ã®æ¨ç§»
                const section = sections[currentSectionIndex];

                // ãƒ‡ãƒ¼ã‚¿ãªã—ã®å ´åˆ
                if (!section || !section.games || section.games.length === 0) {
                    pointTrendChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['é–‹å§‹'],
                            datasets: [
                                { label: 'è¥¿æ–¹', data: [0], borderColor: '#006835', backgroundColor: '#006835', tension: 0.1, pointRadius: 1 },
                                { label: 'é«˜æ©‹', data: [0], borderColor: '#4A5968', backgroundColor: '#4A5968', tension: 0.1, pointRadius: 1 },
                                { label: 'å¤§ç”°', data: [0], borderColor: '#B60114', backgroundColor: '#B60114', tension: 0.1, pointRadius: 1 }
                            ]
                        },
                        options: {
                            responsive: true,
                            aspectRatio: 1.3,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        pointStyle: 'circle',
                                        font: { size: 9 },
                                        padding: 6
                                    }
                                }
                            },
                            scales: {
                                y: { min: -30, max: 30 }
                            }
                        }
                    });
                    return;
                }

                // ãƒ©ãƒ™ãƒ«ã¨ç´¯ç©ãƒã‚¤ãƒ³ãƒˆã‚’è¨ˆç®—
                labels = ['é–‹å§‹'];
                let nTotal = 0, tTotal = 0, oTotal = 0;
                nishikataData = [0];
                takahashiData = [0];
                otaData = [0];

                section.games.forEach((game, index) => {
                    labels.push(`${index + 1}åŠè˜`);
                    nTotal += game.points[0];
                    tTotal += game.points[1];
                    oTotal += game.points[2];
                    nishikataData.push(nTotal);
                    takahashiData.push(tTotal);
                    otaData.push(oTotal);
                });
            }

            // min/maxã‚’å‹•çš„ã«è¨ˆç®—ï¼ˆ100åˆ»ã¿ã«åˆ‡ã‚Šä¸Šã’/åˆ‡ã‚Šä¸‹ã’ï¼‰
            const allData = [...nishikataData, ...takahashiData, ...otaData];
            const maxPoint = Math.max(...allData);
            const minPoint = Math.min(...allData);
            const yMax = Math.ceil(maxPoint / 100) * 100;
            const yMin = Math.floor(minPoint / 100) * 100;

            // ã‚°ãƒ©ãƒ•æç”»
            pointTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'è¥¿æ–¹',
                            data: nishikataData,
                            borderColor: '#006835',
                            backgroundColor: '#006835',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 1
                        },
                        {
                            label: 'é«˜æ©‹',
                            data: takahashiData,
                            borderColor: '#4A5968',
                            backgroundColor: '#4A5968',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 1
                        },
                        {
                            label: 'å¤§ç”°',
                            data: otaData,
                            borderColor: '#B60114',
                            backgroundColor: '#B60114',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    aspectRatio: 1.3,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: { size: 9 },
                                padding: 6
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            min: yMin,
                            max: yMax,
                            ticks: {
                                stepSize: 100,
                                font: { size: 9 }
                            },
                            grid: {
                                color: (context) => context.tick.value === 0 ? '#333' : '#ddd',
                                lineWidth: (context) => context.tick.value === 0 ? 2 : 1
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 10 }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // å±¥æ­´ã‚’æ›´æ–°
        function updateHistory() {
            const historyList = document.getElementById('historyList');
            const tabsContainer = document.getElementById('tabsContainer');
            
            historyList.innerHTML = '';
            tabsContainer.innerHTML = '';

            if (sections.length === 0) {
                historyList.innerHTML = '<tr><td colspan="5" style="padding: 20px; color: #666;">ã¾ã å¯¾å±€ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            // ã‚¿ãƒ–ã‚’ç”Ÿæˆ
            sections.forEach((section, index) => {
                const tab = document.createElement('div');
                tab.className = `tab ${index === currentSectionIndex ? 'active' : ''}`;
                tab.textContent = `ç¬¬${index + 1}ç¯€`;
                tab.onclick = () => {
                    currentSectionIndex = index;
                    updateHistory();
                };
                tabsContainer.appendChild(tab);
            });

            // æ–°ã—ã„ç¯€ã‚’è¿½åŠ ã™ã‚‹ãƒœã‚¿ãƒ³
            const addBtn = document.createElement('button');
            addBtn.className = 'add-section-btn';
            addBtn.textContent = '+ æ–°ã—ã„ç¯€';
            addBtn.onclick = addNewSection;
            tabsContainer.appendChild(addBtn);

            // ç¾åœ¨ã®ç¯€ã®å¯¾å±€ã‚’å–å¾—
            const currentSection = sections[currentSectionIndex];
            
            if (!currentSection || currentSection.games.length === 0) {
                historyList.innerHTML = '<tr><td colspan="5" style="padding: 20px; color: #666;">ã“ã®ç¯€ã«ã¯ã¾ã å¯¾å±€ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            // è¡¨ã®è¡Œã‚’ç”Ÿæˆ
            currentSection.games.forEach((game, gameIndex) => {
                const row = document.createElement('tr');
                
                // åŠè˜ç•ªå·
                const gameNumCell = document.createElement('td');
                gameNumCell.textContent = `${gameIndex + 1}`;
                gameNumCell.style.fontWeight = 'bold';
                row.appendChild(gameNumCell);

                // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æƒ…å ±
                players.forEach((name, playerIndex) => {
                    const cell = document.createElement('td');
                    const tobiBadge = game.tobiFlags && game.tobiFlags[playerIndex]
                        ? '<div class="tobi-badge">é£›ã³</div>'
                        : '';
                    const tobashiBadge = game.tobashiFlags && game.tobashiFlags[playerIndex]
                        ? '<div class="tobashi-badge">é£›ã°ã—</div>'
                        : '';
                    const doubleTobashiBadge = game.doubleTobashiFlags && game.doubleTobashiFlags[playerIndex]
                        ? '<div class="double-tobashi-badge">ãƒ€ãƒ–ãƒ«é£›ã°ã—</div>'
                        : '';
                    const yakumanBadge = game.yakumanFlags && game.yakumanFlags[playerIndex]
                        ? '<div class="yakuman-badge">å½¹æº€</div>'
                        : '';
                    const doubleYakumanBadge = game.doubleYakumanFlags && game.doubleYakumanFlags[playerIndex]
                        ? '<div class="double-yakuman-badge">ãƒ€ãƒ–ãƒ«å½¹æº€</div>'
                        : '';
                    const tripleYakumanBadge = game.tripleYakumanFlags && game.tripleYakumanFlags[playerIndex]
                        ? '<div class="triple-yakuman-badge">ãƒˆãƒªãƒ—ãƒ«å½¹æº€</div>'
                        : '';

                    let badgesHtml = tobiBadge + tobashiBadge + doubleTobashiBadge + yakumanBadge + doubleYakumanBadge + tripleYakumanBadge;
                    if (!badgesHtml.trim()) {
                        badgesHtml = '<div class="no-badge">ãªã—</div>';
                    }
                    
                    cell.innerHTML = `
                        <div class="player-cell">
                            <div class="player-score">${game.scores[playerIndex]}ç‚¹</div>
                            <div class="player-point">${game.points[playerIndex] > 0 ? '+' : ''}${game.points[playerIndex]}</div>
                            ${badgesHtml}
                        </div>
                    `;
                    row.appendChild(cell);
                });

                // æ“ä½œã‚»ãƒ«ï¼ˆé‡è¦ï¼šclassNameã‚’è¨­å®šï¼‰
                const actionCell = document.createElement('td');
                actionCell.className = 'action-cell';
                
                // ç·¨é›†ãƒœã‚¿ãƒ³
                const editBtn = document.createElement('button');
                editBtn.textContent = 'ç·¨é›†';
                editBtn.onclick = () => editGame(currentSectionIndex, gameIndex);
                actionCell.appendChild(editBtn);
                
                // å‰Šé™¤ãƒœã‚¿ãƒ³
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'å‰Šé™¤';
                deleteBtn.onclick = () => deleteGame(currentSectionIndex, gameIndex);
                actionCell.appendChild(deleteBtn);
                
                row.appendChild(actionCell);
                historyList.appendChild(row);
            });
            
            // åˆè¨ˆè¡Œã‚’è¿½åŠ 
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row'
            totalRow.style.backgroundColor = '#c41e3a';
            
            // ã€Œåˆè¨ˆã€ã‚»ãƒ«
            const totalLabelCell = document.createElement('td');
            totalLabelCell.textContent = 'åˆè¨ˆ';
            totalLabelCell.style.fontWeight = 'bold';
            totalLabelCell.style.fontSize = '11px';
            totalLabelCell.style.color = 'white';
            totalLabelCell.style.textAlign = 'center';
            totalLabelCell.style.verticalAlign = 'middle';
            totalRow.appendChild(totalLabelCell);
            
            // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆè¨ˆãƒã‚¤ãƒ³ãƒˆã‚’è¨ˆç®—
            const totalPoints = [0, 0, 0];
            currentSection.games.forEach(game => {
                game.points.forEach((p, i) => totalPoints[i] += p);
            });
            
            // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆè¨ˆã‚»ãƒ«
            players.forEach((name, playerIndex) => {
                const cell = document.createElement('td');
                cell.style.textAlign = 'center';
                cell.style.verticalAlign = 'middle';
                cell.style.color = 'white';
                cell.innerHTML = `
                    <div style="font-weight: bold; font-size: 13px;">${totalPoints[playerIndex] > 0 ? '+' : ''}${totalPoints[playerIndex]}</div>
                `;
                totalRow.appendChild(cell);
            });
            
            // æ“ä½œã‚»ãƒ«ï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ã®ã¿ï¼‰
            const totalActionCell = document.createElement('td');
            totalActionCell.className = 'action-cell';
            
            // å‰Šé™¤ãƒœã‚¿ãƒ³
            const totalDeleteBtn = document.createElement('button');
            totalDeleteBtn.textContent = 'å‰Šé™¤';
            totalDeleteBtn.onclick = () => deleteSection(currentSectionIndex);
            totalActionCell.appendChild(totalDeleteBtn);
            
            totalRow.appendChild(totalActionCell);
            historyList.appendChild(totalRow);
            
            // ãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’å‹•çš„ã«èª¿æ•´
            setTimeout(() => {
                const rows = historyList.querySelectorAll('tr');
                rows.forEach(row => {
                    const actionCell = row.querySelector('.action-cell');
                    if (!actionCell) return;
                    
                    const buttons = actionCell.querySelectorAll('button');
                    if (buttons.length === 0) return;
                    
                    const cellHeight = actionCell.offsetHeight;
                    const center = cellHeight / 2;
                    
                    if (buttons.length === 1) {
                        // ãƒœã‚¿ãƒ³ãŒ1ã¤ã ã‘ã®å ´åˆï¼ˆåˆè¨ˆè¡Œï¼‰: ä¸­å¤®ã«é…ç½®
                        const singleBtn = buttons[0];
                        singleBtn.style.top = `${center - 10}px`;  // ãƒœã‚¿ãƒ³é«˜ã•20pxã®åŠåˆ†ã‚’å¼•ã
                    } else if (buttons.length === 2) {
                        // ãƒœã‚¿ãƒ³ãŒ2ã¤ã®å ´åˆï¼ˆé€šå¸¸ã®å¯¾å±€è¡Œï¼‰: ä¸Šä¸‹ã«é…ç½®
                        const editBtn = buttons[0];
                        const deleteBtn = buttons[1];
                        
                        // ç·¨é›†ãƒœã‚¿ãƒ³: ä¸­å¤®ã‹ã‚‰ä¸Šã«2pxé›¢ã‚ŒãŸä½ç½®ã«ä¸‹ç«¯ã‚’é…ç½®
                        editBtn.style.top = `${center - 4 - 20}px`;
                        
                        // å‰Šé™¤ãƒœã‚¿ãƒ³: ä¸­å¤®ã‹ã‚‰ä¸‹ã«2pxé›¢ã‚ŒãŸä½ç½®ã«ä¸Šç«¯ã‚’é…ç½®
                        deleteBtn.style.top = `${center + 4}px`;
                    }
                });
            }, 0);

            // ãƒã‚¤ãƒ³ãƒˆæ¨ç§»ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
            updatePointTrendChart();
        }

        //æœ€çµ‚ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæœ€å°é€ãƒã‚¤ãƒ³ãƒˆå›æ•°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰
        function calcFinalPoints() {
            const fee = parseInt(document.getElementById("tableFee").value);
            if (isNaN(fee) || fee <= 0) {
                showError("ã‚²ãƒ¼ãƒ ä»£ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
        
            // æœ€æ–°ã®ç¯€ã®åˆè¨ˆãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—
            const total = [0, 0, 0];
            const sec = sections[sections.length - 1];
        
            sec.games.forEach(g => {
                g.points.forEach((p, i) => total[i] += p);
            });
        
            // â‘  å…¨å“¡ Ã—50
            const moneyPoints = total.map(x => x * 50);
        
            // â‘¡ ã‚²ãƒ¼ãƒ ä»£ã‚’3ã§å‰²ã‚‹ï¼ˆåˆ‡ã‚Šä¸Šã’ï¼‰
            const feeShare = Math.ceil(fee / 3);
        
            // â‘¢ ä½™ã‚Šè¨ˆç®—
            const remainder = feeShare * 3 - fee;
            
            // â‘£ ä½™ã‚Šã®èª¿æ•´
            // 1ä½ã€2ä½ã€3ä½ã‚’ç‰¹å®šï¼ˆåˆè¨ˆãƒã‚¤ãƒ³ãƒˆã§åˆ¤å®šï¼‰
            const rankings = total.map((pt, idx) => ({pt, idx}))
                .sort((a, b) => b.pt - a.pt);
            
            const firstIdx = rankings[0].idx;
            const secondIdx = rankings[1].idx;
            const thirdIdx = rankings[2].idx;
            
            // ä½™ã‚Šèª¿æ•´ç”¨ã®é…åˆ—
            const remainderAdjust = [0, 0, 0];
            
            if (remainder === 2) {
                // ä½™ã‚Š2å††ï¼š2ä½ã¨3ä½ãŒ1å††ãšã¤è»½æ¸›
                remainderAdjust[secondIdx] = +1;
                remainderAdjust[thirdIdx] = +1;
            } else if (remainder === 1) {
                // ä½™ã‚Š1å††ï¼š3ä½ãŒ1å††è»½æ¸›
                remainderAdjust[thirdIdx] = +1;
            }
            
            // â‘¤ æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆ = Ã—50 - feeShare + ä½™ã‚Šèª¿æ•´
            const final = moneyPoints.map((p, i) => p - feeShare + remainderAdjust[i]);
        
            // å·¦å´ã®ã¿çµµæ–‡å­—ã‚’ã¤ã‘ãŸåå‰ã‚’ç”Ÿæˆ
            const leftEmojiNames = players.map(p => {
                const chars = Array.from(p);
                const emoji = chars[0];
                const name = p.replace(/.*(è¥¿æ–¹|é«˜æ©‹|å¤§ç”°).*/, "$1");
                return `${emoji}${name}`;
            });
        
            // --- æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆè¡¨ã®ç”Ÿæˆ ---
            let html = `
                <table class="history-table final-points-table">
                    <thead>
                        <tr>
                            <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th>
                            <th>åˆè¨ˆ</th>
                            <th>Ã—50</th>
                            <th>å ´ä»£</th>
                            <th>æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            players.forEach((name, i) => {
                html += `
                    <tr>
                        <td>${leftEmojiNames[i]}</td>
                        <td>${total[i]}</td>
                        <td>${moneyPoints[i]}</td>
                        <td>-${feeShare}</td>
                        <td style="font-weight: bold; color: #c41e3a;">${final[i]}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                <br>
            `;

            // --- æœ€å°é€ãƒã‚¤ãƒ³ãƒˆå›æ•°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  ---
            const payerIndex = parseInt(document.getElementById("payer").value, 10);
            
            // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è¨ˆç®—
            // æ”¯æ‰•ã„è€…ã¯ç«‹ã¦æ›¿ãˆã¦ã„ã‚‹ã®ã§ã‚²ãƒ¼ãƒ ä»£å…¨é¡ã‚’åŠ ç®—ã€ä»–ã¯è² æ‹…åˆ†ã‚’æ¸›ç®—
            const balances = final.map((pt, i) => {
                if (i === payerIndex) {
                    return pt + fee;  // ç«‹ã¦æ›¿ãˆãŸåˆ†ã‚’åŠ ç®—
                } else {
                    return pt;  // æ—¢ã«feeShareãŒå¼•ã‹ã‚Œã¦ã„ã‚‹
                }
            });
            
            // ãƒãƒ©ãƒ³ã‚¹ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’çµã³ã¤ã‘ãŸé…åˆ—ã‚’ä½œæˆ
            const balanceData = balances.map((balance, index) => ({
                index: index,
                name: leftEmojiNames[index],
                balance: balance
            }));
            
            // é€ãƒã‚¤ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¨ˆç®—
            const transactions = [];
            const workingBalances = balanceData.map(d => ({ ...d }));
            
            while (true) {
                // æœ€ã‚‚å‚µæ¨©ãŒå¤šã„äººï¼ˆãƒ—ãƒ©ã‚¹ãŒå¤§ãã„ï¼‰
                let maxCreditor = null;
                // æœ€ã‚‚è² å‚µãŒå¤šã„äººï¼ˆãƒã‚¤ãƒŠã‚¹ãŒå¤§ãã„ï¼‰
                let maxDebtor = null;
                
                for (const person of workingBalances) {
                    if (maxCreditor === null || person.balance > maxCreditor.balance) {
                        maxCreditor = person;
                    }
                    if (maxDebtor === null || person.balance < maxDebtor.balance) {
                        maxDebtor = person;
                    }
                }
                
                // å…¨å“¡ã®ãƒãƒ©ãƒ³ã‚¹ãŒ0ã«è¿‘ã‘ã‚Œã°çµ‚äº†ï¼ˆèª¤å·®1å††ã¾ã§è¨±å®¹ï¼‰
                if (Math.abs(maxCreditor.balance) < 1 && Math.abs(maxDebtor.balance) < 1) {
                    break;
                }
                
                // é€ãƒã‚¤ãƒ³ãƒˆé¡ã‚’è¨ˆç®—
                const amount = Math.min(maxCreditor.balance, Math.abs(maxDebtor.balance));
                
                if (amount < 1) break;  // 1å††æœªæº€ãªã‚‰çµ‚äº†
                
                // é€ãƒã‚¤ãƒ³ãƒˆã‚’è¨˜éŒ²
                transactions.push({
                    from: maxDebtor.name,
                    to: maxCreditor.name,
                    amount: Math.round(amount)
                });
                
                // ãƒãƒ©ãƒ³ã‚¹ã‚’æ›´æ–°
                maxCreditor.balance -= amount;
                maxDebtor.balance += amount;
            }
            
            // --- é€ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ã®è¡¨ç¤º ---
            html += `<div style="text-align:center; font-size:16px; color:#2d5016; line-height:2; margin-top:10px; padding:15px; background:white; border-radius:8px; border:2px solid #2d5016;">`;
            
            if (transactions.length === 0) {
                html += `<span style="color:#666;">é€ãƒã‚¤ãƒ³ãƒˆã®å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“</span>`;
            } else {
                transactions.forEach(tx => {
                    html += `${tx.from} â¡ï¸ ${tx.to} ã« <span style="color:#c41e3a; font-weight:bold; font-size:18px;">${tx.amount} pt</span><br>`;
                    });
                html += `
                    <a href="paypay://"
                        style="
                            display:inline-block;
                            margin-top:10px;
                            padding:5px 20px;
                            background:#FF0033;
                            color:white;
                            font-weight:bold;
                            border-radius:8px;
                            text-decoration:none;
                        ">
                        ãƒã‚¤ãƒ³ãƒˆã‚’é€ã‚‹
                    </a>
                `;
                }
            
            html += `</div>`;

            document.getElementById("finalPointsResult").innerHTML = html;
            
            // PayPayãƒœã‚¿ãƒ³ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            requestAnimationFrame(() => {
                setTimeout(() => {
                    const finalPointsResult = document.getElementById("finalPointsResult");
                    if (finalPointsResult && finalPointsResult.offsetHeight > 0) {
                        finalPointsResult.scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'end'
                        });
                    }
                }, 100);
            });
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ã§å–å¾—ï¼ˆæ›´æ–°ãƒœã‚¿ãƒ³ç”¨ï¼‰
        async function refreshData() {
            try {
                await loadData();
                showDialog('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸï¼', 'ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°');
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showDialog('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°');
            }
        }

        // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¨ã—ã¦ä¿å­˜
        // ä¿å­˜ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºï¼‰
        function saveSnapshot() {
            if (sections.length === 0) {
                showDialog('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜');
                return;
            }
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
            document.getElementById('saveConfirmDialogOverlay').style.display = 'flex';
        }
        
        // ä¿å­˜ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        function closeSaveConfirmDialog() {
            document.getElementById('saveConfirmDialogOverlay').style.display = 'none';
        }
        
        // ä¿å­˜ã‚’ç¢ºå®šã—ã¦å®Ÿè¡Œ
        async function confirmSaveSnapshot() {
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
            closeSaveConfirmDialog();
            
            // æœ€æ–°ã®ç¯€ç•ªå·ã‚’å–å¾—
            const latestSectionNumber = sections.length;
            
            // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç”Ÿæˆ (YYYYMMDD_HHMMSS)
            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
            const snapshotName = `Tãƒªãƒ¼ã‚°ç¬¬${latestSectionNumber}ç¯€æ™‚ç‚¹_${timestamp}`;
            
            // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            const snapshotData = {
                name: snapshotName,
                timestamp: now.toISOString(),
                sectionNumber: latestSectionNumber,
                sections: sections
            };
            
            try {
                // Cloudflare Workerã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ä¿å­˜
                const res = await fetch(`${API_URL}/snapshot`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": API_TOKEN
                    },
                    body: JSON.stringify({
                        key: snapshotName,
                        data: snapshotData
                    })
                });
                
                if (res.ok) {
                    // âœ… æˆåŠŸï¼šã‚«ã‚¹ã‚¿ãƒ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ç·‘ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ã€ŒæˆåŠŸã€ï¼‰
                    showDialog(`è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\n${snapshotName}`, 'æˆåŠŸ', '#2d5016');
                } else {
                    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼', res.status);
                    showDialog(
                        'è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nWorkerå´ã§ /mahjong/snapshot ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚',
                        'å¤±æ•—'
                    );
                }
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showDialog('è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'å¤±æ•—');
            }
        }
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>














